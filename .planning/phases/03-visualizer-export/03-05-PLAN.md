---
phase: 03-visualizer-export
plan: 05
type: execute
wave: 3
depends_on: ["03-01"]
files_modified: [src/components/export/ExportButton.tsx, src/utils/export.ts]
autonomous: true
user_setup: []

must_haves:
  truths:
    - "exportSlideAsPNG wrapper function calls html2canvas"
    - "html2canvas renders with scale: 2 for retina sharpness (3200px wide)"
    - "generateExportFilename creates timestamped filename"
    - "ExportButton component handles loading and error states"
  artifacts:
    - path: "src/utils/export.ts"
      provides: "Export utility with html2canvas wrapper"
      exports: ["exportSlideAsPNG", "generateExportFilename"]
    - path: "src/components/export/ExportButton.tsx"
      provides: "Export button component"
  key_links:
    - from: "src/utils/export.ts"
      to: "html2canvas"
      via: "import statement"
      pattern: "import.*html2canvas"
    - from: "ExportButton.tsx"
      to: "src/utils/export.ts"
      via: "import and function call"
      pattern: "exportSlideAsPNG"
---

<objective>
Create export utility and ExportButton component with html2canvas integration.

Purpose: Build the foundation for high-resolution PNG export of annotated slides.
Output: export.ts utility with html2canvas wrapper and ExportButton component.
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/03-visualizer-export/03-CONTEXT.md
@.planning/phases/03-visualizer-export/03-RESEARCH.md

# html2canvas installed in Plan 03-01
@.planning/phases/03-visualizer-export/03-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Create export utility with html2canvas wrapper</name>
  <files>src/utils/export.ts</files>
  <action>
    Create src/utils/export.ts:

    ```typescript
    import html2canvas from 'html2canvas'

    /**
     * Exports a DOM element as high-resolution PNG using html2canvas.
     * Per Phase 3 Research: scale: 2 for retina sharpness (3200px wide).
     *
     * @param element - The DOM element to capture (e.g., SlideWrapper)
     * @param filename - Base filename for the download (without extension)
     */
    export async function exportSlideAsPNG(
      element: HTMLElement,
      filename: string
    ): Promise<void> {
      try {
        const canvas = await html2canvas(element, {
          scale: 2,                    // 2x for retina sharpness (3200px wide)
          useCORS: true,              // Handle cross-origin images if present
          logging: false,             // Disable console spam
          backgroundColor: '#FFFFFF', // White background
        })

        // Convert canvas to PNG data URL
        const dataUrl = canvas.toDataURL('image/png')

        // Trigger download
        const link = document.createElement('a')
        link.download = `${filename}.png`
        link.href = dataUrl
        link.click()
      } catch (error) {
        console.error('Export failed:', error)
        throw new Error('Failed to export slide as PNG')
      }
    }

    /**
     * Generates filename with timestamp.
     * Format: phish-analysis-{title}-{timestamp}.png
     */
    export function generateExportFilename(projectTitle?: string): string {
      const sanitizedTitle = projectTitle
        ? projectTitle.toLowerCase().replace(/[^a-z0-9]+/g, '-')
        : 'untitled'
      const timestamp = new Date().toISOString().replace(/[:.]/g, '').slice(0, -5)
      return `phish-analysis-${sanitizedTitle}-${timestamp}`
    }
    ```

    Why scale: 2: Per Phase 3 Context, 2x scale renders at 3200px wide for retina sharpness. Ensures presentations look crisp on 4K projectors and when zoomed/cropped.

    Why useCORS: true: Per Phase 3 Research, handles any cross-origin images that might be present in the email content.

    Why logging: false: html2canvas is verbose by default. Disabling prevents console spam.

    Error handling: Catches html2canvas failures (e.g., unsupported CSS) and re-throws with user-friendly message. ExportButton will show toast notification.
  </action>
  <verify>test -f src/utils/export.ts && grep -q "html2canvas" src/utils/export.ts</verify>
  <done>Export utility created with html2canvas wrapper and filename generator</done>
</task>

<task type="auto">
  <name>Create ExportButton component</name>
  <files>src/components/export/ExportButton.tsx</files>
  <action>
    Create src/components/export/ExportButton.tsx:

    ```tsx
    import React, { useState } from 'react'
    import { exportSlideAsPNG, generateExportFilename } from '../../utils/export'

    interface ExportButtonProps {
      slideWrapperRef: React.RefObject<HTMLDivElement>
      projectTitle?: string
      disabled?: boolean
    }

    export function ExportButton({
      slideWrapperRef,
      projectTitle,
      disabled = false,
    }: ExportButtonProps) {
      const [isExporting, setIsExporting] = useState(false)
      const [error, setError] = useState<string | null>(null)

      const handleExport = async () => {
        if (!slideWrapperRef.current) {
          setError('Slide wrapper not found')
          return
        }

        setIsExporting(true)
        setError(null)

        try {
          const filename = generateExportFilename(projectTitle)
          await exportSlideAsPNG(slideWrapperRef.current, filename)
        } catch (err) {
          setError(err instanceof Error ? err.message : 'Export failed')
          // TODO: Show toast notification (deferred to Phase 5)
          console.error('Export error:', err)
        } finally {
          setIsExporting(false)
        }
      }

      return (
        <div className="export-button-container">
          <button
            onClick={handleExport}
            disabled={disabled || isExporting}
            className="export-button"
            type="button"
          >
            {isExporting ? 'Exporting...' : 'Export PNG'}
          </button>
          {error && <div className="export-error">{error}</div>}
        </div>
      )
    }
    ```

    Why disabled state: Export takes 1-3 seconds with html2canvas. Button shows "Exporting..." state to prevent double-clicks and provide feedback.

    Why error handling: html2canvas can fail (e.g., tainted canvas from cross-origin images). Error message helps user understand what went wrong.

    TODO: Toast notification deferred to Phase 5 (Data & Persistence) when notification system is added.
  </action>
  <verify>test -f src/components/export/ExportButton.tsx && grep -q "ExportButton" src/components/export/ExportButton.tsx</verify>
  <done>ExportButton component created with loading and error states</done>
</task>

</tasks>

<verification>
- exportSlideAsPNG function calls html2canvas with scale: 2
- generateExportFilename creates timestamped filename
- ExportButton component handles loading and error states
- Export is disabled while exporting
- Errors are displayed inline
</verification>

<success_criteria>
- export.ts utility ready for integration
- ExportButton component ready for App.tsx integration
- Foundation ready for Plan 03-07 (App.tsx preview mode + SlideWrapper forwardRef + CSS)
</success_criteria>

<output>
After completion, create `.planning/phases/03-visualizer-export/03-05-SUMMARY.md`
</output>
