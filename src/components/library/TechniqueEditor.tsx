/**
 * TechniqueEditor component for creating and editing custom phishing techniques
 *
 * Provides a form with validation for:
 * - Name (required)
 * - Tactic (required, dropdown from built-in tactics)
 * - Description (required)
 * - URL (optional, with http/https validation)
 *
 * Integrates with useCustomTechniques hook for persistence.
 */

import { useState, useEffect } from 'react';
import type { CustomTechnique } from '../../types/library';
import { addCustomTechnique, updateCustomTechnique, CUSTOM_TECHNIQUES_KEY } from '../../hooks/useCustomTechniques';

interface TechniqueEditorProps {
  /**
   * Existing technique to edit (optional)
   */
  technique?: CustomTechnique;

  /**
   * Callback when technique is saved successfully
   */
  onSave?: (technique: CustomTechnique) => void;

  /**
   * Callback when form is cancelled
   */
  onCancel?: () => void;
}

/**
 * Available tactics from built-in MITRE techniques
 */
const AVAILABLE_TACTICS = [
  'Initial Access',
  'Resource Development',
  'Defense Evasion',
  'Execution',
  'Command and Control',
] as const;

/**
 * Validate URL format (must be http or https)
 */
function isValidUrl(url: string): boolean {
  if (!url.trim()) return true; // Empty URL is valid (optional field)
  try {
    const parsed = new URL(url);
    return parsed.protocol === 'http:' || parsed.protocol === 'https:';
  } catch {
    return false;
  }
}

/**
 * TechniqueEditor component
 */
export function TechniqueEditor({ technique, onSave, onCancel }: TechniqueEditorProps) {
  // Form state
  const [name, setName] = useState(technique?.name || '');
  const [tactic, setTactic] = useState(technique?.tactic || '');
  const [description, setDescription] = useState(technique?.description || '');
  const [url, setUrl] = useState(technique?.url || '');

  // Validation state
  const [errors, setErrors] = useState<Record<string, string>>({});
  const [isSaving, setIsSaving] = useState(false);
  const [saveError, setSaveError] = useState<string | null>(null);

  // Reset form when technique prop changes (for edit mode)
  useEffect(() => {
    if (technique) {
      setName(technique.name);
      setTactic(technique.tactic);
      setDescription(technique.description);
      setUrl(technique.url || '');
      setErrors({});
      setSaveError(null);
    }
  }, [technique]);

  /**
   * Validate form fields
   */
  const validate = (): boolean => {
    const newErrors: Record<string, string> = {};

    // Name validation
    if (!name.trim()) {
      newErrors.name = 'Name is required';
    } else if (name.trim().length < 3) {
      newErrors.name = 'Name must be at least 3 characters';
    }

    // Tactic validation
    if (!tactic) {
      newErrors.tactic = 'Tactic is required';
    }

    // Description validation
    if (!description.trim()) {
      newErrors.description = 'Description is required';
    } else if (description.trim().length < 10) {
      newErrors.description = 'Description must be at least 10 characters';
    }

    // URL validation (optional, but must be valid if provided)
    if (url.trim() && !isValidUrl(url)) {
      newErrors.url = 'URL must start with http:// or https://';
    }

    setErrors(newErrors);
    return Object.keys(newErrors).length === 0;
  };

  /**
   * Handle form submission
   */
  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();

    // Clear previous errors
    setSaveError(null);

    // Validate form
    if (!validate()) {
      return;
    }

    setIsSaving(true);

    try {
      // Load custom techniques from LocalStorage
      const stored = localStorage.getItem(CUSTOM_TECHNIQUES_KEY);
      const customTechniques: Record<string, CustomTechnique> = stored ? JSON.parse(stored) : {};

      let savedTechnique: CustomTechnique;

      if (technique) {
        // Update existing technique
        const updatedTechnique: CustomTechnique = {
          ...technique,
          name: name.trim(),
          tactic,
          description: description.trim(),
          url: url.trim() || undefined,
        };

        // Update in LocalStorage directly
        customTechniques[technique.id] = updatedTechnique;
        localStorage.setItem(CUSTOM_TECHNIQUES_KEY, JSON.stringify(customTechniques));

        savedTechnique = updatedTechnique;
      } else {
        // Add new technique
        const techniqueData = {
          id: '', // Will be generated by addCustomTechnique
          name: name.trim(),
          tactic,
          description: description.trim(),
          url: url.trim() || undefined,
          isCustom: true as const,
          createdAt: new Date().toISOString(),
        };

        const id = addCustomTechnique(techniqueData);

        // Get the saved technique
        const afterStored = localStorage.getItem(CUSTOM_TECHNIQUES_KEY);
        const afterCustomTechniques: Record<string, CustomTechnique> = afterStored ? JSON.parse(afterStored) : {};
        savedTechnique = afterCustomTechniques[id];
      }

      // Reset form for new entries
      if (!technique) {
        setName('');
        setTactic('');
        setDescription('');
        setUrl('');
        setErrors({});
      }

      // Notify parent
      onSave?.(savedTechnique);
    } catch (error) {
      console.error('Failed to save custom technique:', error);
      setSaveError('Failed to save technique. Please try again.');
    } finally {
      setIsSaving(false);
    }
  };

  /**
   * Handle cancel action
   */
  const handleCancel = () => {
    // Reset form if creating new
    if (!technique) {
      setName('');
      setTactic('');
      setDescription('');
      setUrl('');
      setErrors({});
    }
    onCancel?.();
  };

  return (
    <div className="technique-editor">
      <h3>{technique ? 'Edit Custom Technique' : 'Add Custom Technique'}</h3>

      <form onSubmit={handleSubmit} className="technique-form">
        {/* Name field */}
        <div className="form-group">
          <label htmlFor="technique-name" className="form-label">
            Name <span className="required">*</span>
          </label>
          <input
            type="text"
            id="technique-name"
            className={`form-input ${errors.name ? 'input-error' : ''}`}
            value={name}
            onChange={(e) => setName(e.target.value)}
            placeholder="e.g., CEO Fraud Variant"
            disabled={isSaving}
          />
          {errors.name && <div className="field-error">{errors.name}</div>}
        </div>

        {/* Tactic field */}
        <div className="form-group">
          <label htmlFor="technique-tactic" className="form-label">
            Tactic <span className="required">*</span>
          </label>
          <select
            id="technique-tactic"
            className={`form-select ${errors.tactic ? 'input-error' : ''}`}
            value={tactic}
            onChange={(e) => setTactic(e.target.value)}
            disabled={isSaving}
          >
            <option value="">Select tactic...</option>
            {AVAILABLE_TACTICS.map((t) => (
              <option key={t} value={t}>
                {t}
              </option>
            ))}
          </select>
          {errors.tactic && <div className="field-error">{errors.tactic}</div>}
        </div>

        {/* Description field */}
        <div className="form-group">
          <label htmlFor="technique-description" className="form-label">
            Description <span className="required">*</span>
          </label>
          <textarea
            id="technique-description"
            className={`form-textarea ${errors.description ? 'input-error' : ''}`}
            rows={4}
            value={description}
            onChange={(e) => setDescription(e.target.value)}
            placeholder="Describe the phishing technique and how it's used..."
            disabled={isSaving}
          />
          {errors.description && <div className="field-error">{errors.description}</div>}
        </div>

        {/* URL field (optional) */}
        <div className="form-group">
          <label htmlFor="technique-url" className="form-label">
            URL (optional)
          </label>
          <input
            type="text"
            id="technique-url"
            className={`form-input ${errors.url ? 'input-error' : ''}`}
            value={url}
            onChange={(e) => setUrl(e.target.value)}
            placeholder="https://attack.mitre.org/techniques/T1566/"
            disabled={isSaving}
          />
          {errors.url && <div className="field-error">{errors.url}</div>}
        </div>

        {/* Save error */}
        {saveError && <div className="form-error">{saveError}</div>}

        {/* Form actions */}
        <div className="form-actions">
          <button
            type="button"
            className="button button-secondary"
            onClick={handleCancel}
            disabled={isSaving}
          >
            Cancel
          </button>
          <button
            type="submit"
            className="button button-primary"
            disabled={isSaving}
          >
            {isSaving ? 'Saving...' : 'Save Technique'}
          </button>
        </div>
      </form>
    </div>
  );
}
