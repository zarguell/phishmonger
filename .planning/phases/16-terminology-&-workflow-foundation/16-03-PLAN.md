---
phase: 16-terminology-workflow-foundation
plan: 03
type: execute
wave: 2
depends_on: [16-02]
files_modified:
  - src/utils/schemaVersion.ts
autonomous: true
user_setup: []

must_haves:
  truths:
    - Existing users with "phishmonger-project-id" key have their data migrated to "phishmonger-phish-id"
    - Schema version increments from 2 to 3 after migration
    - Migration only runs once (subsequent app loads skip migration)
    - User data is preserved without loss during migration
    - Fresh installs (no existing data) start directly at schema version 3
  artifacts:
    - path: "src/utils/schemaVersion.ts"
      provides: "Schema version management with v2→v3 migration"
      exports: ["CURRENT_SCHEMA_VERSION", "initializeSchema", "migrateV2ToV3"]
      contains: "CURRENT_SCHEMA_VERSION = 3"
  key_links:
    - from: "src/utils/schemaVersion.ts"
      to: "localStorage"
      via: "getItem/setItem calls for migration"
      pattern: "phishmonger-project-id|phishmonger-phish-id"
    - from: "src/App.tsx"
      to: "src/utils/schemaVersion.ts"
      via: "initializeSchema call on mount"
      pattern: "initializeSchema\\(\\)"
---

<objective>
Implement localStorage schema migration from v2 to v3 with project-id key rename

Purpose: Migrate existing user data from the old "phishmonger-project-id" localStorage key to "phishmonger-phish-id", preserving all user data without loss. This migration runs automatically on app mount and increments the schema version to 3.

Output: Updated schemaVersion.ts with migrateV2ToV3 function and CURRENT_SCHEMA_VERSION = 3
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/16-terminology-&-workflow-foundation/16-RESEARCH.md

@src/utils/schemaVersion.ts
@src/App.tsx
@.planning/phases/16-terminology-&-workflow-foundation/16-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Increment CURRENT_SCHEMA_VERSION from 2 to 3</name>
  <files>src/utils/schemaVersion.ts</files>
  <action>
    Update the schema version constant:
    1. Line 16: export const CURRENT_SCHEMA_VERSION = 2; → export const CURRENT_SCHEMA_VERSION = 3;
    2. Update the JSDoc comment at line 15: "// Current schema version (v1.2)" → "// Current schema version (v1.3)"

    Also update the schema versions comment block at the top:
    3. Line 9: Add "- v3: Phish terminology rename (v1.3)" to the schema versions list

    This change signals to the initializeSchema function that migration may be needed.
  </action>
  <verify>grep "CURRENT_SCHEMA_VERSION = 3" src/utils/schemaVersion.ts returns a match</verify>
  <done>Schema version incremented to 3</done>
</task>

<task type="auto">
  <name>Task 2: Create migrateV2ToV3 migration function</name>
  <files>src/utils/schemaVersion.ts</files>
  <action>
    Add a new migration function after the initializeSchema function:

    ```typescript
    /**
     * Migrate schema from v2 to v3
     *
     * Changes:
     * - Rename localStorage key: phishmonger-project-id → phishmonger-phish-id
     * - Update default title in metadata from "Untitled Project" to "Untitled Phish"
     *
     * This migration preserves all existing user data.
     */
    function migrateV2ToV3(): void {
      console.log('Starting schema migration v2 → v3...');

      // Step 1: Migrate phishmonger-project-id → phishmonger-phish-id
      const oldProjectId = localStorage.getItem('phishmonger-project-id');
      if (oldProjectId) {
        localStorage.setItem('phishmonger-phish-id', oldProjectId);
        localStorage.removeItem('phishmonger-project-id');
        console.log('✓ Migrated phishmonger-project-id → phishmonger-phish-id');
      } else {
        console.log('  No phishmonger-project-id found, skipping key migration');
      }

      // Step 2: Update default title in metadata (if still "Untitled Project")
      const metadataStr = localStorage.getItem('phishmonger-metadata');
      if (metadataStr) {
        try {
          const metadata = JSON.parse(metadataStr);
          if (metadata.title === 'Untitled Project') {
            metadata.title = 'Untitled Phish';
            localStorage.setItem('phishmonger-metadata', JSON.stringify(metadata));
            console.log('✓ Updated default title from "Untitled Project" to "Untitled Phish"');
          } else {
            console.log('  Metadata title already customized, skipping update');
          }
        } catch (error) {
          console.error('  Failed to update metadata:', error);
        }
      }

      console.log('Schema v2 → v3 migration complete');
    }
    ```

    Place this function after the initializeSchema function (after line 43).
  </action>
  <verify>grep -n "function migrateV2ToV3" src/utils/schemaVersion.ts returns a match</verify>
  <done>migrateV2ToV3 function created with proper migration logic</done>
</task>

<task type="auto">
  <name>Task 3: Update initializeSchema to call migrateV2ToV3 when needed</name>
  <files>src/utils/schemaVersion.ts</files>
  <action>
    Modify the initializeSchema function to call the migration when schema version < 3:

    1. Find the existing migration check block (around lines 37-42)
    2. Replace the console.log comment with actual migration call:

    Change FROM:
    ```typescript
    if (version < CURRENT_SCHEMA_VERSION) {
      // Schema migration needed (not needed for v1.2 since no existing users)
      console.log(`Schema migration needed: v${version} → v${CURRENT_SCHEMA_VERSION}`);
      localStorage.setItem(SCHEMA_VERSION_KEY, CURRENT_SCHEMA_VERSION.toString());
    }
    ```

    Change TO:
    ```typescript
    if (version < CURRENT_SCHEMA_VERSION) {
      console.log(`Schema migration needed: v${version} → v${CURRENT_SCHEMA_VERSION}`);

      // Run migrations based on current version
      if (version === 2) {
        migrateV2ToV3();
      }

      // Update version after successful migration
      localStorage.setItem(SCHEMA_VERSION_KEY, CURRENT_SCHEMA_VERSION.toString());
    }
    ```

    This ensures migration runs only when upgrading from v2 to v3.
  </action>
  <verify>grep -n "migrateV2ToV3()" src/utils/schemaVersion.ts returns a match within initializeSchema</verify>
  <done>initializeSchema calls migrateV2ToV3 when schema version is 2</done>
</task>

<task type="auto">
  <name>Task 4: Update JSDoc comments to reflect v3 schema</name>
  <files>src/utils/schemaVersion.ts</files>
  <action>
    Update documentation comments to reflect the new v3 schema:

    1. Line 5-11: Update the schema versions list comment:
       FROM:
       ```
       * Schema versions:
       * - v1: Initial schema (implicit, no version field)
       * - v2: Campaign data model with campaigns array and scheduledDate (v1.2)
       ```

       TO:
       ```
       * Schema versions:
       * - v1: Initial schema (implicit, no version field)
       * - v2: Campaign data model with campaigns array and scheduledDate (v1.2)
       * - v3: Phish terminology rename - localStorage key updates (v1.3)
       ```

    2. Line 19-27: Update initializeSchema JSDoc:
       FROM: "Sets the schema version to CURRENT_SCHEMA_VERSION (v1.2)..."
       TO: "Sets the schema version to CURRENT_SCHEMA_VERSION (v1.3)..."

    3. Remove outdated comment about "no existing users" since we now handle migration.
  </action>
  <verify>grep -n "v3: Phish terminology" src/utils/schemaVersion.ts returns a match</verify>
  <done>JSDoc comments accurately reflect v3 schema changes</done>
</task>

</tasks>

<verification>
After completing all tasks:
1. Run TypeScript compilation: npm run build
2. Verify no type errors

3. Test migration with fresh install:
   - Open browser DevTools → Application → Local Storage
   - Delete all localStorage entries for the app
   - Refresh the page
   - Verify "phishmonger-schema-version" is set to "3"
   - Verify no migration logs appear in console (first-time user)

4. Test migration from v2:
   - Open browser DevTools → Application → Local Storage
   - Manually set: phishmonger-schema-version = "2"
   - Manually add: phishmonger-project-id = "test-id-123"
   - Manually add: phishmonger-metadata = {"title":"Untitled Project","author":"","createdAt":"2024-01-01T00:00:00.000Z"}
   - Refresh the page
   - Verify console shows migration logs
   - Verify phishmonger-phish-id exists with "test-id-123"
   - Verify phishmonger-project-id no longer exists
   - Verify phishmonger-metadata title is now "Untitled Phish"
   - Verify phishmonger-schema-version is now "3"
</verification>

<success_criteria>
1. CURRENT_SCHEMA_VERSION is 3
2. migrateV2ToV3 function exists and is called from initializeSchema
3. Fresh installs start at schema version 3 without migration
4. Existing v2 users are migrated to v3 automatically
5. All user data is preserved during migration
6. Migration only runs once (not on subsequent app loads)
</success_criteria>

<output>
After completion, create `.planning/phases/16-terminology-&-workflow-foundation/16-03-SUMMARY.md`
</output>
