---
phase: 05-data-persistence
plan: 03
type: execute
wave: 3
depends_on: [05-01, 05-02]
files_modified:
  - src/components/ProjectSettings.tsx
  - src/App.tsx
autonomous: false

must_haves:
  truths:
    - "User can click Export JSON button to download project file"
    - "User can import project by uploading JSON file"
    - "User can import project by pasting JSON text in text area"
    - "ProjectSettings panel visible in edit mode with metadata inputs"
    - "Imported project restores all state (htmlSource, annotations, scoring, metadata)"
  artifacts:
    - path: "src/components/ProjectSettings.tsx"
      provides: "Settings panel with Export/Import buttons"
      contains: "export button", "import file input", "paste textarea"
    - path: "src/App.tsx"
      provides: "ProjectSettings integration and import handlers"
      contains: "ProjectSettings component", "handleImportJSON"
  key_links:
    - from: "src/components/ProjectSettings.tsx"
      to: "src/utils/storage.ts"
      via: "exportProjectJSON, downloadProjectJSON, importProjectJSON"
      pattern: "exportProjectJSON|downloadProjectJSON|importProjectJSON"
    - from: "src/App.tsx"
      to: "src/components/ProjectSettings.tsx"
      via: "onExport, onImport props"
      pattern: "onExport|onImport"
    - from: "src/App.tsx"
      to: "state"
      via: "setState calls to restore htmlSource, annotations, scoring, metadata"
      pattern: "setHtmlSource|setAnnotations|setScoring|setMetadata"
---

<objective>
Create Export/Import UI components and integrate into App, completing the data persistence layer with full project backup and restore capabilities

Purpose: Enable users to export complete projects as JSON files and import projects from either file upload or text paste, providing backup and sharing functionality

Output: ProjectSettings with Export/Import UI, integrated in App header, dual import methods (file + paste)
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/REQUIREMENTS.md

@.planning/phases/05-data-persistence/05-01-SUMMARY.md
@.planning/phases/05-data-persistence/05-02-SUMMARY.md

@src/App.tsx
@src/components/ProjectSettings.tsx
@src/utils/storage.ts
@src/types/project.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Export/Import UI to ProjectSettings component</name>
  <files>src/components/ProjectSettings.tsx</files>
  <action>
    Update src/components/ProjectSettings.tsx to add export/import UI:

    Add new props:
    - onExport: () => void (callback for export button)
    - onImportFromFile: (file: File) => void (callback for file import)
    - onImportFromText: (jsonText: string) => void (callback for text paste import)

    Add UI section below metadata inputs (separate with divider):

    1. Export button:
       - Label: "Export JSON"
       - Clicking calls onExport callback
       - Style: Primary button (matches existing button styles)

    2. Import from file:
       - Label: "Import from File"
       - File input (accept=".json")
       - On file select, read file with FileReader and call onImportFromFile

    3. Import from text paste (DATA-07):
       - Label: "Import from Pasted JSON"
       - Textarea for pasting JSON (placeholder: "Paste project JSON here...")
       - "Import" button below textarea
       - On import click, call onImportFromText with textarea content
       - Clear textarea on successful import
       - Show error message if import fails (red text below textarea)

    Import error handling:
    - Wrap onImportFromText callback in try/catch
    - Display error message from importProjectJSON validation
    - Clear error on new paste or successful import

    Use existing component patterns for consistency (see ExportButton.tsx for error display pattern).
  </action>
  <verify>grep -q "Export JSON" src/components/ProjectSettings.tsx && grep -q "Import from File" && grep -q "Import from Pasted JSON"</verify>
  <done>ProjectSettings has export button, file import, and text paste import with error handling</done>
</task>

<task type="auto">
  <name>Task 2: Wire export/import handlers in App.tsx</name>
  <files>src/App.tsx</files>
  <action>
    Update src/App.tsx to add export/import handlers and ProjectSettings integration:

    1. Add export handler (after handleUpdateMetadata):
    ```typescript
    const handleExportJSON = () => {
      const jsonString = exportProjectJSON(metadata, htmlSource, annotations, scoring, inputMode)
      const filename = `${metadata.title.replace(/[^a-z0-9]/gi, '-').toLowerCase()}-${new Date().toISOString().split('T')[0]}`
      downloadProjectJSON(jsonString, filename)
    }
    ```

    2. Add import handler (after handleExportJSON):
    ```typescript
    const handleImportJSON = (project: ProjectJSON) => {
      setMetadata(project.metadata)
      setHtmlSource(project.htmlSource)
      setAnnotations(project.annotations)
      setScoring(project.scoring)
      setInputMode(project.inputMode)
    }
    ```

    3. Import ProjectJSON type: import type { ProjectJSON } from './utils/storage'

    4. In edit mode header (replace header section), add ProjectSettings above or next to header:
       ```tsx
       <header className="app-header">
         <div className="header-top">
           <h1>Phish Monger</h1>
           <ProjectSettings
             metadata={metadata}
             onUpdate={handleUpdateMetadata}
             onExport={handleExportJSON}
             onImportFromFile={(file) => {
               const reader = new FileReader()
               reader.onload = (e) => {
                 try {
                   const json = e.target?.result as string
                   const project = importProjectJSON(json)
                   handleImportJSON(project)
                 } catch (error) {
                   // Error handled in ProjectSettings
                   throw error
                 }
               }
               reader.readAsText(file)
             }}
             onImportFromText={(jsonText) => {
               const project = importProjectJSON(jsonText)
               handleImportJSON(project)
             }}
           />
         </div>
         <p>Phishing Email Annotation Tool</p>
         <div className="header-actions">
           <button onClick={() => setViewMode('preview')} ...>
           ...
         </div>
       </header>
       ```

    5. Add CSS for header-top flex layout (if needed) to separate ProjectSettings from title/actions

    Import errors propagate to ProjectSettings component for display.
  </action>
  <verify>grep -q "handleExportJSON" src/App.tsx && grep -q "handleImportJSON" && grep -q "ProjectSettings"</verify>
  <done>Export generates JSON file with project title, import restores all state from file or text</done>
</task>

<task type="checkpoint:human-verify">
  <what-built>Complete Export/Import UI with dual import methods (file upload + text paste)</what-built>
  <how-to-verify>
    1. Run app: npm run dev
    2. Verify ProjectSettings panel appears in edit mode header
    3. Test metadata input: Enter title "Test Project" and author "Test Author"
    4. Create some lures and annotations in the editor
    5. Export test: Click "Export JSON" and verify file downloads with name "test-project-[date].json"
    6. Open downloaded JSON file and verify it contains: metadata.title, htmlSource, annotations, scoring, inputMode
    7. Clear browser: Clear all LocalStorage in DevTools → Application → LocalStorage
    8. Refresh page (should show empty state)
    9. Import from file test: Click "Import from File", select the JSON file from step 6
    10. Verify all state restored: Title "Test Project", lures, annotations, scoring
    11. Import from paste test: Copy JSON content to clipboard, click "Import from Pasted JSON", paste in textarea, click Import
    12. Verify state restored again
    13. Error test: Paste invalid JSON "{broken" and click Import - verify error message appears
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues</resume-signal>
</task>

</tasks>

<verification>
- ProjectSettings panel visible in edit mode header
- Export JSON button downloads file with correct naming
- Import from file restores all project state (htmlSource, annotations, scoring, metadata)
- Import from text paste restores all project state
- Invalid JSON shows error message in UI
- Metadata persists across page refreshes
- Exported JSON contains all required fields
</verification>

<success_criteria>
1. Export button downloads JSON file with project data
2. File import restores complete application state
3. Text paste import restores complete application state
4. Invalid JSON shows user-friendly error message
5. All 7 DATA requirements met (DATA-01 through DATA-07)
</success_criteria>

<output>
After completion, create `.planning/phases/05-data-persistence/05-03-SUMMARY.md`
</output>
