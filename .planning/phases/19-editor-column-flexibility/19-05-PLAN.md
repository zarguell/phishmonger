---
phase: 19-editor-column-flexibility
plan: 05
type: execute
wave: 1
depends_on: []
files_modified:
  - src/App.tsx
  - src/utils/storage.ts
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "User can minimize any column to collapsed header bar via minimize button"
    - "Multiple columns can be minimized simultaneously"
    - "Collapsed columns persist across page refreshes"
  artifacts:
    - path: "src/App.tsx"
      provides: "ColumnHeader with minimize button, collapsedColumns state"
      contains: "collapsedColumns"
    - path: "src/utils/storage.ts"
      provides: "loadCollapsedColumns, saveCollapsedColumns functions"
      exports: ["loadCollapsedColumns", "saveCollapsedColumns"]
  key_links:
    - from: "src/App.tsx"
      to: "src/utils/storage.ts"
      via: "import { loadCollapsedColumns, saveCollapsedColumns }"
      pattern: "import.*loadCollapsedColumns|saveCollapsedColumns"
---

<objective>
Add minimize button functionality to column headers, enabling users to collapse individual columns to header bar state while keeping other columns visible. Multiple columns can be minimized simultaneously, and collapsed state persists to localStorage.

Purpose: EDIT-01 requires minimize buttons separate from expand buttons, allowing direct column collapse without affecting other columns.
Output: Minimize button in each column header, collapsedColumns Set<ColumnID> state, localStorage persistence for collapsed columns
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/phases/19-editor-column-flexibility/19-editor-column-flexibility-VERIFICATION.md
@.planning/phases/19-editor-column-flexibility/19-01-SUMMARY.md
@.planning/phases/19-editor-column-flexibility/19-02-SUMMARY.md

# Gap context from VERIFICATION.md
Gap: "User minimizes any column to collapsed header bar via header button" - FAILED
Reason: "No minimize button exists in column headers. Current implementation has only expand/reset toggle (+/−)."

Missing from gap:
- Minimize button in column headers (separate from expand button)
- State management for multiple columns in collapsed state

# Existing implementation from 19-01, 19-02
- ColumnHeader component with expand button (+/− toggle) at line 569 in App.tsx
- focusedColumn state (null | ColumnID) for full-width focus mode
- toggleColumnFocus() function for focus mode
- loadFocusedColumn(), saveFocusedColumn() storage utilities
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add collapsed columns storage utilities</name>
  <files>src/utils/storage.ts</files>
  <action>
Add collapsed columns storage utilities following the same pattern as focusedColumn from 19-01:

1. Add COLLAPSED_COLUMNS_KEY constant after FOCUSED_COLUMN_KEY (around line 294)
2. Add loadCollapsedColumns() function that:
   - Reads from localStorage using COLLAPSED_COLUMNS_KEY
   - Parses JSON array of column IDs
   - Validates each ID against VALID_COLUMN_IDS Set
   - Returns Set<ColumnID> (empty set if not found or invalid)
   - Has try-catch error handling with console.error
3. Add saveCollapsedColumns() function that:
   - Accepts Set<ColumnID> parameter
   - Converts to Array and JSON.stringify for storage
   - Saves to localStorage using COLLAPSED_COLUMNS_KEY
   - Removes key if set is empty
   - Handles QuotaExceededError gracefully (same pattern as saveFocusedColumn)

Reference existing functions loadFocusedColumn() (line 302) and saveFocusedColumn() (line 323) for error handling and validation patterns.
  </action>
  <verify>grep -n "loadCollapsedColumns\|saveCollapsedColumns" src/utils/storage.ts returns function definitions</verify>
  <done>Storage utilities exist and follow Phase 16 error-handling pattern from 19-01</done>
</task>

<task type="auto">
  <name>Task 2: Add collapsed columns state and minimize button to ColumnHeader</name>
  <files>src/App.tsx</files>
  <action>
Add collapsed columns state management and update ColumnHeader component with minimize button:

1. Import loadCollapsedColumns and saveCollapsedColumns from storage.ts (update line 33 import)
2. Add collapsedColumns state after focusedColumn state (around line 165):
   ```typescript
   const [collapsedColumns, setCollapsedColumns] = useState<Set<ColumnID>>(() => {
     try {
       const saved = loadCollapsedColumns();
       return saved || new Set<ColumnID>();
     } catch (error) {
       console.error('Failed to load collapsed columns:', error);
       return new Set<ColumnID>();
     }
   });
   ```
3. Add toggleColumnCollapsed() function after toggleColumnFocus():
   ```typescript
   const toggleColumnCollapsed = (columnId: ColumnID) => {
     setCollapsedColumns(prev => {
       const newSet = new Set(prev);
       if (newSet.has(columnId)) {
         newSet.delete(columnId); // Expand from collapsed
       } else {
         newSet.add(columnId); // Collapse
       }
       saveCollapsedColumns(newSet);
       return newSet;
     });
   };
   ```
4. Update ColumnHeader component (around line 569) to accept isCollapsed prop and add minimize button:
   ```typescript
   const ColumnHeader = ({ title, columnId, onToggle, onMinimize, isCollapsed }: {
     title: string
     columnId: ColumnID
     onToggle: () => void
     onMinimize: () => void
     isCollapsed: boolean
   }) => (
     <div className="column-header">
       <span className="column-header-title">{title}</span>
       <div className="column-header-actions">
         <button
           className="minimize-column-btn"
           onClick={onMinimize}
           title={isCollapsed ? "Expand" : "Minimize"}
           type="button"
         >
           {isCollapsed ? '↑' : '↓'}
         </button>
         <button
           className="expand-column-btn"
           onClick={onToggle}
           title={focusedColumn === columnId ? "Reset to normal view" : "Expand to full width"}
           type="button"
         >
           {focusedColumn === columnId ? '−' : '+'}
         </button>
       </div>
     </div>
   )
   ```
5. Update all 4 ColumnHeader usages (around lines 682, 722, 733, 746) to pass:
   - onMinimize={() => toggleColumnCollapsed('input'/'preview'/'lure-list'/'scoring')}
   - isCollapsed={collapsedColumns.has('input'/'preview'/'lure-list'/'scoring')}

Reference existing ColumnHeader from 19-01 (line 569) for current structure.
Reference toggleColumnFocus() (line 172) for state management pattern.
  </action>
  <verify>
grep -n "collapsedColumns\|toggleColumnCollapsed" src/App.tsx returns state and function definitions
grep -n "minimize-column-btn" src/App.tsx returns 4 matches (one per column)
  </verify>
  <done>ColumnHeader has separate minimize and expand buttons, collapsedColumns state manages multiple minimized columns</done>
</task>

<task type="auto">
  <name>Task 3: Add useEffect for collapsed columns persistence</name>
  <files>src/App.tsx</files>
  <action>
Add useEffect hook to persist collapsedColumns state changes to localStorage, following the same pattern as focusedColumn persistence from 19-01:

Add useEffect after the focusedColumn useEffect (around line 213):
```typescript
// Persist collapsed columns state to localStorage
useEffect(() => {
  saveCollapsedColumns(collapsedColumns);
}, [collapsedColumns]);
```

This ensures collapsed columns state is saved whenever it changes, matching the persistence pattern from 19-01 (line 203-207 for focusedColumn).
  </action>
  <verify>grep -A2 "Persist collapsed columns" src/App.tsx returns useEffect with saveCollapsedColumns call</verify>
  <done>Collapsed columns state persists to localStorage on every change</done>
</task>

</tasks>

<verification>
TypeScript compilation: npx tsc --noEmit passes without errors

Functionality checks:
- collapsedColumns state initialized from localStorage on app mount
- Minimize button (↓) appears in all 4 column headers
- Clicking minimize adds columnId to collapsedColumns Set
- Clicking minimize again (↑) removes from Set
- Multiple columns can be minimized simultaneously
- saveCollapsedColumns called on state changes
- collapsedColumns Set persists across page refresh
</verification>

<success_criteria>
- Collapsed columns state management works correctly
- Minimize button exists and functions in all 4 column headers
- Multiple columns can be minimized independently
- Collapsed state persists across page refreshes via localStorage
- TypeScript compilation passes
</success_criteria>

<output>
After completion, create `.planning/phases/19-editor-column-flexibility/19-05-SUMMARY.md`
</output>
