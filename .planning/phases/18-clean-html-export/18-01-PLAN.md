---
phase: 18-clean-html-export
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/utils/cleanHtmlExport.ts
autonomous: true

must_haves:
  truths:
    - "HTML sanitization utility exists with functions to strip lure marks and badges"
    - "Utility provides file download function using Blob API"
    - "Utility provides clipboard copy function using Navigator Clipboard API"
    - "Utility generates safe filenames from phish titles"
  artifacts:
    - path: "src/utils/cleanHtmlExport.ts"
      provides: "HTML cleaning and export utilities"
      exports:
        - "stripLureMarks"
        - "stripAnnotationBadges"
        - "generateCleanHtml"
        - "downloadCleanHtml"
        - "copyCleanHtmlToClipboard"
        - "generateCleanHtmlFilename"
      min_lines: 80
  key_links:
    - from: "cleanHtmlExport.ts"
      to: "DOMParser API"
      via: "new DOMParser()"
      pattern: "new DOMParser\\(\\)"
    - from: "cleanHtmlExport.ts"
      to: "Navigator Clipboard API"
      via: "navigator.clipboard.writeText()"
      pattern: "navigator\\.clipboard\\.writeText"
    - from: "cleanHtmlExport.ts"
      to: "Blob API"
      via: "new Blob()"
      pattern: "new Blob\\(\\[.*\\],.*type.*text/html"
---

<objective>
Create utility module for cleaning and exporting HTML without annotation artifacts.

Purpose: Provide reusable functions that strip lure mark spans and annotation badges from email HTML, enabling clean export for email clients and browsers.
Output: New `src/utils/cleanHtmlExport.ts` with DOMParser-based sanitization and export functions.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/18-clean-html-export/18-RESEARCH.md

# Reference patterns from existing code
@src/utils/icalExport.ts
@src/utils/export.ts
@src/components/campaign/ReadOnlyEditor.tsx
@src/components/preview/EmailColumn.tsx
@src/extensions/LureMark.ts
</context>

<tasks>

<task type="auto">
  <name>Create cleanHtmlExport utility module</name>
  <files>src/utils/cleanHtmlExport.ts</files>
  <action>
Create new file `src/utils/cleanHtmlExport.ts` with the following implementation:

1. **Helper function `removeElementsFromHTML()`**:
   - Takes `htmlString: string` and `selector: string`
   - Uses `new DOMParser()` to parse HTML: `parser.parseFromString(htmlString, 'text/html')`
   - Queries all elements matching selector: `doc.querySelectorAll(selector)`
   - Removes each element: `element.remove()`
   - Returns cleaned HTML: `doc.body.innerHTML`

2. **Export function `stripLureMarks(htmlString: string): string`**:
   - Calls `removeElementsFromHTML(htmlString, '[data-lure-id]')`
   - Removes all `<span data-lure-id="..." class="lure-mark">` elements

3. **Export function `stripAnnotationBadges(htmlString: string): string`**:
   - Calls `removeElementsFromHTML(htmlString, '[data-annotation-number]')`
   - Removes all `<span class="lure-badge" data-annotation-number="...">` elements

4. **Export function `generateCleanHtml(htmlSource: string): string`**:
   - Applies `stripLureMarks()` then `stripAnnotationBadges()`
   - Returns HTML with all UI artifacts removed

5. **Export function `generateCleanHtmlFilename(projectTitle?: string): string`**:
   - Sanitizes title: `projectTitle.toLowerCase().replace(/[^a-z0-9]+/g, '-')`
   - Returns `{sanitized-title}.html` or `'untitled.html'`

6. **Export function `downloadCleanHtml(htmlSource: string, filename: string): void`**:
   - Calls `generateCleanHtml(htmlSource)` to get clean HTML
   - Creates Blob: `new Blob([cleanHtml], { type: 'text/html; charset=utf-8' })`
   - Creates object URL: `URL.createObjectURL(blob)`
   - Creates anchor element, sets href and download attributes
   - Appends to body, clicks, removes from body
   - Revokes URL: `URL.revokeObjectURL(url)`
   - Follow the exact pattern from `icalExport.ts` lines 59-78

7. **Export async function `copyCleanHtmlToClipboard(htmlSource: string): Promise<void>`**:
   - Calls `generateCleanHtml(htmlSource)` to get clean HTML
   - Uses `await navigator.clipboard.writeText(cleanHtml)`
   - Wraps in try-catch, throws descriptive error on failure
   - Follow the exact pattern from `ReadOnlyEditor.tsx` lines 29-37

DO NOT use regex for HTML manipulation - use DOMParser only.
DO NOT modify source data - always work with copies.
  </action>
  <verify>
1. File exists at `src/utils/cleanHtmlExport.ts`
2. TypeScript compiles without errors: `npm run type-check` or `npx tsc --noEmit`
3. All required exports present: `stripLureMarks`, `stripAnnotationBadges`, `generateCleanHtml`, `downloadCleanHtml`, `copyCleanHtmlToClipboard`, `generateCleanHtmlFilename`
  </verify>
  <done>
Utility module created with all export functions using DOMParser, Navigator Clipboard API, and Blob API following existing codebase patterns.
</done>
</task>

</tasks>

<verification>
After task completion:
- [ ] `src/utils/cleanHtmlExport.ts` exists and compiles
- [ ] All 6 functions exported with correct signatures
- [ ] DOMParser used for HTML manipulation (not regex)
- [ ] Follows icalExport.ts pattern for download
- [ ] Follows ReadOnlyEditor.tsx pattern for clipboard
</verification>

<success_criteria>
1. Utility module compiles without TypeScript errors
2. All functions have proper TypeScript types
3. Selector patterns `[data-lure-id]` and `[data-annotation-number]` match actual HTML structure from LureMark.ts and EmailColumn.tsx
4. Download and clipboard functions follow existing patterns
</success_criteria>

<output>
After completion, create `.planning/phases/18-clean-html-export/18-01-SUMMARY.md`
</output>
