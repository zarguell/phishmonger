---
phase: 01-editor-foundation
plan: 02
type: execute
wave: 2
depends_on: ["01-01"]
files_modified: [src/extensions/LureMark.ts, src/utils/sanitizeHtml.ts]
autonomous: true
user_setup: []

must_haves:
  truths:
    - "Lure Mark extension can wrap text in spans with unique UUID"
    - "Sanitizer removes dangerous HTML but preserves layout tables and inline styles"
  artifacts:
    - path: "src/extensions/LureMark.ts"
      provides: "Tiptap NodeView extension for Lure Marks"
      exports: ["LureMark"]
      contains: "NodeViewWrapper", "data-lure-id"
    - path: "src/utils/sanitizeHtml.ts"
      provides: "HTML sanitization function using DOMPurify"
      exports: ["sanitizeHtml"]
      contains: "DOMPurify.sanitize"
  key_links:
    - from: "src/extensions/LureMark.ts"
      to: "@tiptap/react"
      via: "NodeViewWrapper import"
      pattern: "import.*NodeViewWrapper.*from.*@tiptap/react"
    - from: "src/utils/sanitizeHtml.ts"
      to: "dompurify"
      via: "DOMPurify.sanitize"
      pattern: "DOMPurify\\.sanitize"
---

<objective>
Create the Lure Mark Tiptap extension and DOMPurify paste handler.

Purpose: These are the core building blocks for the editor. The Lure Mark extension enables users to mark deceptive text with unique identifiers. The sanitization handler ensures pasted HTML is safe while preserving email layout.

Output:
- LureMark.ts: Custom Tiptap extension wrapping text in span[data-lure-id] with yellow highlight
- sanitizeHtml.ts: DOMPurify wrapper preserving tables and inline styles but stripping scripts and events
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/STATE.md
@.planning/ROADMAP.md
@.planning/REQUIREMENTS.md
@.planning/phases/01-editor-foundation/01-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Create Lure Mark Tiptap extension</name>
  <files>src/extensions/LureMark.ts, package.json, package-lock.json</files>
  <action>
    First, install uuid package: `npm install uuid @types/uuid --save-exact`

    Then create src/extensions/LureMark.ts:

    ```typescript
    import { Node, mergeAttributes } from '@tiptap/core'
    import { v4 as uuidv4 } from 'uuid'

    export const LureMark = Node.create({
      name: 'lureMark',

      group: 'inline',

      inline: true,

      atom: true,

      addAttributes() {
        return {
          lureId: {
            default: uuidv4(),
          },
        }
      },

      parseHTML() {
        return [
          {
            tag: 'span[data-lure-id]',
          },
        ]
      },

      renderHTML({ HTMLAttributes }) {
        return [
          'span',
          mergeAttributes(HTMLAttributes, {
            'data-lure-id': HTMLAttributes.lureId,
            class: 'lure-mark',
          }),
          0,
        ]
      },
    })
    ```

    This extension:
    - Wraps text in span with data-lure-id attribute
    - Generates unique UUID for each Lure Mark
    - Adds 'lure-mark' class for CSS styling
    - Parses existing span[data-lure-id] elements
  </action>
  <verify>
    Run `npm list uuid @types/uuid` and confirm both are installed.
    Check that src/extensions/LureMark.ts exists and exports LureMark extension.
  </verify>
  <done>
    Lure Mark Tiptap extension is created with UUID generation and span wrapping.
  </done>
</task>

<task type="auto">
  <name>Implement DOMPurify paste handler</name>
  <files>src/utils/sanitizeHtml.ts</files>
  <action>
    Create src/utils/sanitizeHtml.ts:

    ```typescript
    import DOMPurify from 'dompurify'

    export function sanitizeHtml(html: string): string {
      return DOMPurify.sanitize(html, {
        ALLOWED_TAGS: [
          // Text formatting
          'p', 'b', 'i', 'u', 'strong', 'em', 'span', 'div',
          // Links
          'a',
          // Lists
          'ul', 'ol', 'li',
          // Headings
          'h1', 'h2', 'h3', 'h4', 'h5', 'h6',
          // Tables (preserves email layout)
          'table', 'thead', 'tbody', 'tfoot', 'tr', 'th', 'td',
          // Block elements
          'br', 'hr',
          // Inline
          'sub', 'sup',
        ],
        ALLOWED_ATTR: [
          // Links
          'href', 'target', 'rel',
          // Spans and divs (for inline styles)
          'style', 'class',
          // Tables
          'colspan', 'rowspan', 'align', 'valign',
          // Lure Mark attribute
          'data-lure-id',
        ],
        ALLOWED_URI_REGEXP: /^(?:(?:(?:f|ht)tps?|mailto|tel|callto|sms|cid|xmpp):|[^a-z]|[a-z+.\-]+(?:[^a-z+.\-:]|$))/i,

        // Strip dangerous elements and events
        FORBID_TAGS: ['script', 'iframe', 'object', 'embed', 'form', 'input', 'button'],
        FORBID_ATTR: ['onclick', 'onload', 'onerror', 'onmouseover', 'onmouseout', 'onfocus', 'onblur'],

        // Keep safe CSS styles for layout preservation
        ALLOWED_STYLES: [
          'text-align', 'color', 'background-color',
          'font-family', 'font-size', 'font-weight', 'font-style',
          'text-decoration', 'text-transform',
          'padding', 'margin', 'border', 'width', 'height',
          'display', 'float', 'position', 'clear',
        ],
      })
    }
    ```

    This sanitization:
    - Preserves email layout (tables, inline styles, formatting)
    - Strips scripts, iframes, forms (security)
    - Strips all on* event handlers (security)
    - Allows specific safe CSS properties for layout preservation
    - Allows data-lure-id for Lure Marks
  </action>
  <verify>
    Run `npm list uuid @types/uuid` and confirm both are installed.
    Check that src/utils/sanitizeHtml.ts exists and exports sanitizeHtml function.
    Test that sanitizeHtml strips scripts: call sanitizeHtml('<script>alert(1)</script>') and expect empty string.
  </verify>
  <done>
    DOMPurify sanitization function preserves email layout but removes dangerous HTML and events.
  </done>
</task>

</tasks>

<verification>
1. Check src/extensions/LureMark.ts - Exports LureMark extension with name, group, inline, atom, parseHTML, renderHTML
2. Check src/utils/sanitizeHtml.ts - Exports sanitizeHtml function with DOMPurify configuration
3. Test sanitization: Run quick test to confirm scripts are stripped but tables preserved
4. Verify uuid package is installed
</verification>

<success_criteria>
- LureMark extension wraps text in span[data-lure-id] with unique UUID
- LureMark adds 'lure-mark' class for styling
- sanitizeHtml preserves tables and inline styles
- sanitizeHtml strips scripts, iframes, forms, and on* events
- uuid package is installed for Lure Mark ID generation
</success_criteria>

<output>
After completion, create `.planning/phases/01-editor-foundation/01-02-SUMMARY.md`
</output>
