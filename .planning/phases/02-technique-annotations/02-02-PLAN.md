---
phase: 02-technique-annotations
plan: 02
type: execute
wave: 2
depends_on: [02-01]
files_modified: [src/App.tsx, src/components/AnnotationPanel.tsx]
autonomous: true
user_setup: []

must_haves:
  truths:
    - "App.tsx manages annotations state with Record<lureId, Annotation>"
    - "AnnotationPanel component renders form for technique selection"
    - "User can select technique from dropdown and enter custom MITRE ID and explanation"
  artifacts:
    - path: "src/App.tsx"
      provides: "Annotation state management"
      contains: "useState<Record<string, Annotation>>"
    - path: "src/components/AnnotationPanel.tsx"
      provides: "Annotation form UI component"
      min_lines: 80
      exports: ["AnnotationPanel"]
  key_links:
    - from: "src/App.tsx"
      to: "src/types/annotations.ts"
      via: "Import Annotation type"
      pattern: "import.*Annotation.*from"
    - from: "src/components/AnnotationPanel.tsx"
      to: "src/data/techniques.json"
      via: "Import technique library"
      pattern: "import.*techniques.*from"
    - from: "src/components/AnnotationPanel.tsx"
      to: "src/types/annotations.ts"
      via: "Use Annotation and Technique types"
      pattern: "interface AnnotationPanelProps"
---

<objective>
Create the UI and state management for technique annotations: add annotation state to App.tsx and build an AnnotationPanel component with technique dropdown and form fields.

Purpose: Enable users to select phishing techniques from a pre-loaded library and write custom explanations for each marked lure.
Output: Functional annotation state management and form UI component.
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/STATE.md
@.planning/ROADMAP.md
@.planning/REQUIREMENTS.md
@.planning/phases/02-technique-annotations/02-RESEARCH.md
@.planning/phases/01-editor-foundation/01-07-SUMMARY.md
@.planning/phases/02-technique-annotations/02-01-SUMMARY.md
@src/types/annotations.ts
@src/data/techniques.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add annotation state management to App.tsx</name>
  <files>src/App.tsx</files>
  <action>
    Extend App.tsx with annotation state management following the Record<lureId, Annotation> pattern from 02-RESEARCH.md.

    1. Import Annotation type from types/annotations.ts:
       ```typescript
       import type { Annotation } from './types/annotations'
       ```

    2. Add annotations state after htmlSource state:
       ```typescript
       const [annotations, setAnnotations] = useState<Record<string, Annotation>>(() => {
         const saved = localStorage.getItem('phishmonger-annotations')
         return saved ? JSON.parse(saved) : {}
       })
       ```

    3. Create updateAnnotation helper function:
       ```typescript
       const updateAnnotation = (lureId: string, updates: Partial<Annotation>) => {
         setAnnotations(prev => ({
           ...prev,
           [lureId]: {
             ...prev[lureId],
             ...updates,
             lureId,
             updatedAt: new Date().toISOString()
           }
         }))
       }
       ```

    IMPORTANT: Do NOT add LocalStorage persistence yet (that's Task 3 in Plan 03). Just initialize state and create the update function.

    Also update handleRemoveLure to accept annotations parameter (for future use):
    ```typescript
    const handleRemoveLure = (lureId: string) => {
      // ...existing HTML removal logic...

      // Remove annotation (will be added in Plan 03)
      // setAnnotations(prev => {
      //   const { [lureId]: removed, ...rest } = prev
      //   return rest
      // })
    }
    ```

    Do NOT pass annotations or updateAnnotation to LureList yet (that's Plan 03). Just set up the state infrastructure.
  </action>
  <verify>
    TypeScript compilation succeeds: `npx tsc --noEmit`. Check that Annotation type is imported and annotations state is defined.
  </verify>
  <done>
    App.tsx has annotation state management ready to be passed to child components.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create AnnotationPanel component</name>
  <files>src/components/AnnotationPanel.tsx</files>
  <action>
    Create src/components/AnnotationPanel.tsx with form controls for technique selection and annotation editing.

    Import types and techniques:
    ```typescript
    import type { Annotation, Technique } from '../types/annotations'
    import techniques from '../data/techniques.json'
    ```

    Define props interface:
    ```typescript
    interface AnnotationPanelProps {
      lureId: string
      lureText: string
      annotation?: Annotation
      onUpdate: (updates: Partial<Annotation>) => void
    }
    ```

    Implement the component with:
    - Header showing lure text in quotes: `Annotate: "{lureText}"`
    - Technique dropdown using native `<select>` with options from techniques array
      - Default option: "Select technique..."
      - Each option shows: "{id}: {name}"
    - Custom MITRE ATT&CK ID text input (type="text", placeholder="T1566.001")
    - Explanation textarea (placeholder="Explain why this lure matches the technique...", rows=4)
    - All fields use controlled components with value={annotation?.field || ''}
    - onChange handlers call onUpdate({ field: value })

    Follow existing component patterns from LureList.tsx and Editor.tsx for consistency.

    Use semantic HTML with label elements wrapping each input group.

    Add basic CSS classes for styling (matching lure-list-* patterns):
    - annotation-panel (container)
    - annotation-field (each field group)
    - annotation-label (labels)
    - annotation-select, annotation-input, annotation-textarea (inputs)

    Do NOT use complex form libraries - native HTML form controls are sufficient.
  </action>
  <verify>
    TypeScript compilation succeeds: `npx tsc --noEmit`. Component has all required props and handlers.
  </verify>
  <done>
    AnnotationPanel component renders technique dropdown and annotation form fields ready for integration.
  </done>
</task>

</tasks>

<verification>
- App.tsx imports Annotation type and has annotations state
- updateAnnotation function correctly merges partial updates
- AnnotationPanel component compiles with TypeScript
- Form fields are controlled components with proper onChange handlers
- Techniques dropdown includes all 12 techniques from JSON
</verification>

<success_criteria>
Annotation state management exists in App.tsx and AnnotationPanel component is ready to render technique selection forms.
</success_criteria>

<output>
After completion, create `.planning/phases/02-technique-annotations/02-02-SUMMARY.md`
</output>
