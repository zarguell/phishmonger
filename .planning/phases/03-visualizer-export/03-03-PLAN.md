---
phase: 03-visualizer-export
plan: 03
type: execute
wave: 2
depends_on: ["03-02"]
files_modified: [src/components/preview/AnnotationColumn.tsx, src/components/annotation/AnnotationCard.tsx, src/hooks/useCardLayout.ts, src/index.css]
autonomous: true
user_setup: []

must_haves:
  truths:
    - "Annotation cards display technique name, MITRE ID badge, and explanation"
    - "Cards are 380px wide and auto-grow height based on content"
    - "Overlapping cards are pushed down by 24px gap (collision detection)"
    - "Cards are centered in 640px annotation column (130px padding each side)"
  artifacts:
    - path: "src/components/annotation/AnnotationCard.tsx"
      provides: "Floating annotation card component"
    - path: "src/hooks/useCardLayout.ts"
      provides: "Collision detection for card positioning"
      exports: ["useCardLayout"]
    - path: "src/components/preview/AnnotationColumn.tsx"
      provides: "Column of positioned annotation cards"
  key_links:
    - from: "AnnotationColumn.tsx"
      to: "useCardLayout"
      via: "import and hook usage"
      pattern: "useCardLayout\\(annotations\\)"
    - from: "AnnotationColumn.tsx"
      to: "AnnotationCard"
      via: "JSX component"
      pattern: "<AnnotationCard"
    - from: "useCardLayout.ts"
      to: "src/data/techniques.json"
      via: "import for card height estimation"
      pattern: "import.*techniques"
---

<objective>
Create annotation cards with collision detection and positioning logic.

Purpose: Render floating side-cards for each annotation with proper spacing to prevent overlap.
Output: AnnotationCard component and useCardLayout hook for collision-aware positioning.
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/03-visualizer-export/03-CONTEXT.md
@.planning/phases/03-visualizer-export/03-RESEARCH.md

@src/types/annotations.ts
@src/data/techniques.json
@src/components/preview/AnnotationColumn.tsx

# Prior Phase 2 plans
@.planning/phases/02-technique-annotations/02-01-SUMMARY.md
@.planning/phases/02-technique-annotations/02-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Create AnnotationCard component with technique badge</name>
  <files>src/components/annotation/AnnotationCard.tsx</files>
  <action>
    Create src/components/annotation/AnnotationCard.tsx:

    ```tsx
    import React from 'react'
    import type { Annotation } from '../types/annotations'

    interface AnnotationCardProps {
      annotation: Annotation
      style?: React.CSSProperties
    }

    export function AnnotationCard({ annotation, style }: AnnotationCardProps) {
      return (
        <div className="annotation-card" style={style}>
          <h3 className="annotation-card-title">
            {annotation.techniqueId}
          </h3>
          <span className="annotation-card-badge">
            {annotation.techniqueId}
          </span>
          <p className="annotation-card-explanation">
            {annotation.explanation}
          </p>
        </div>
      )
    }
    ```

    Why separate component: Per Phase 3 architecture, annotation cards need to be individually positioned and measured for arrow calculations. A dedicated component with refs enables getBoundingClientRect() measurements.

    Note: Technique name will be added in Plan 03 by loading from techniques.json based on techniqueId.
  </action>
  <verify>test -f src/components/annotation/AnnotationCard.tsx && grep -q "annotation-card" src/components/annotation/AnnotationCard.tsx</verify>
  <done>AnnotationCard component created with technique badge styling</done>
</task>

<task type="auto">
  <name>Create useCardLayout hook for collision detection</name>
  <files>src/hooks/useCardLayout.ts</files>
  <action>
    Create src/hooks/useCardLayout.ts:

    ```tsx
    import { useMemo } from 'react'
    import type { Annotation } from '../types/annotations'

    interface CardPosition {
      lureId: string
      y: number
    }

    /**
     * Calculates vertical positions for annotation cards with collision detection.
     * Overlapping cards are pushed down by 24px gap.
     */
    export function useCardLayout(annotations: Record<string, Annotation>): CardPosition[] {
      return useMemo(() => {
        const positions: CardPosition[] = []
        const annotationArray = Object.values(annotations)
        let currentY = 0
        const gap = 24

        // Simple sequential positioning with collision avoidance
        // Cards are sorted by creation date or annotation order
        annotationArray.forEach((annotation) => {
          positions.push({
            lureId: annotation.lureId,
            y: currentY,
          })

          // Estimate card height (will be refined by actual DOM measurements)
          const estimatedHeight = estimateCardHeight(annotation.explanation)
          currentY += estimatedHeight + gap
        })

        return positions
      }, [annotations])
    }

    /**
     * Estimates card height based on explanation text length.
     * Base height (title + badge + padding) + text height.
     */
    function estimateCardHeight(explanation: string): number {
      const baseHeight = 60 // Title + badge + padding
      const lineHeight = 20 // 14px text with ~6px line-height
      const charsPerLine = 50 // Approximate 380px width
      const textHeight = Math.ceil(explanation.length / charsPerLine) * lineHeight

      return baseHeight + textHeight
    }
    ```

    Why collision detection: Per Phase 3 Context, cards vertically align to their lure's Y-coordinate initially, but overlapping cards are pushed down by 24px gap. This simple sequential approach works well for the typical number of annotations (5-10 per email).

    Why estimated heights: Actual DOM measurements require refs on all cards, which complicates the hook. Estimated heights provide good initial positioning, and arrows will recalculate on mount with useLayoutEffect.
  </action>
  <verify>test -f src/hooks/useCardLayout.ts && grep -q "useCardLayout" src/hooks/useCardLayout.ts</verify>
  <done>useCardLayout hook created with collision detection logic</done>
</task>

<task type="auto">
  <name>Update AnnotationColumn to render positioned cards</name>
  <files>src/components/preview/AnnotationColumn.tsx</files>
  <action>
    Update src/components/preview/AnnotationColumn.tsx to render annotation cards with positions:

    ```tsx
    import React from 'react'
    import type { Annotation } from '../../types/annotations'
    import { useCardLayout } from '../../hooks/useCardLayout'
    import { AnnotationCard } from '../annotation/AnnotationCard'

    interface AnnotationColumnProps {
      annotations: Record<string, Annotation>
    }

    export function AnnotationColumn({ annotations }: AnnotationColumnProps) {
      const cardPositions = useCardLayout(annotations)
      const hasAnnotations = Object.keys(annotations).length > 0

      if (!hasAnnotations) {
        return (
          <div className="annotation-column">
            <div className="ghost-card">
              No annotations yet. Switch to Edit Mode to highlight lures.
            </div>
          </div>
        )
      }

      return (
        <div className="annotation-column">
          {cardPositions.map((position) => {
            const annotation = annotations[position.lureId]
            if (!annotation) return null

            return (
              <AnnotationCard
                key={annotation.lureId}
                annotation={annotation}
                style={{
                  position: 'absolute',
                  top: position.y,
                  left: '130px', // Center in 640px column: (640 - 380) / 2
                  width: '380px',
                }}
              />
            )
          })}
        </div>
      )
    }
    ```

    Changes:
    - Import useCardLayout hook
    - Import AnnotationCard component
    - Render cards with absolute positioning from hook
    - Center cards horizontally: left: 130px (640px column - 380px card = 260px remaining / 2)

    Why absolute positioning: Per Phase 3 Context, cards are positioned at specific Y-coordinates to align with their lure's vertical position. Absolute positioning within the relative annotation-column enables precise Y control.
  </action>
  <verify>grep -q "useCardLayout" src/components/preview/AnnotationColumn.tsx && grep -q "AnnotationCard" src/components/preview/AnnotationColumn.tsx</verify>
  <done>AnnotationColumn renders positioned annotation cards</done>
</task>

<task type="auto">
  <name>Add CSS for annotation cards with OrangeRed theme</name>
  <files>src/index.css</files>
  <action>
    Add CSS to src/index.css for annotation cards:

    ```css
    /* Annotation Cards */
    .annotation-card {
      background: #FFFFFF;
      border: 1px solid #dee2e6;
      border-radius: 8px;
      padding: 16px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    .annotation-card-title {
      margin: 0 0 8px 0;
      font-size: 16px;
      font-weight: bold;
      color: #212529;
    }

    .annotation-card-badge {
      display: inline-block;
      border: 1px solid #FF4500;
      color: #FF4500;
      background: #FFF5F5;
      border-radius: 12px;
      padding: 2px 8px;
      font-size: 12px;
      font-weight: bold;
      margin-bottom: 12px;
    }

    .annotation-card-explanation {
      margin: 0;
      font-size: 14px;
      color: #495057;
      line-height: 1.5;
      word-wrap: break-word;
    }
    ```

    Why OrangeRed (#FF4500) theme: Per Phase 3 Context, unified OrangeRed color creates clear visual hierarchy. The badge styling matches the specified pill style with light orange background (#FFF5F5).

    Note: box-shadow is used here but will be omitted in the exported slide (Plan 05) since html2canvas has limited support for this CSS property.
  </action>
  <verify>grep -q "\.annotation-card" src/index.css && grep -q "#FF4500" src/index.css</verify>
  <done>CSS for annotation cards added with OrangeRed theme</done>
</task>

</tasks>

<verification>
- AnnotationCard renders with title, badge, and explanation
- Cards are 380px wide and position: absolute
- useCardLayout calculates positions with 24px gap between cards
- Cards are centered in 640px column (left: 130px)
- Badge has OrangeRed styling with pill border
- Ghost card still appears when no annotations exist
</verification>

<success_criteria>
- Annotation cards render in right column
- Cards are positioned with collision detection (no overlap)
- Each card shows technique ID badge and explanation
- Layout is ready for arrow overlays (Plan 04) to connect lures to cards
</success_criteria>

<output>
After completion, create `.planning/phases/03-visualizer-export/03-03-SUMMARY.md`
</output>
