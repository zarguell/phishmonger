---
phase: 02-technique-annotations
plan: 03
type: execute
wave: 3
depends_on: [02-02]
files_modified: [src/components/LureList.tsx, src/App.tsx, src/utils/storage.ts]
autonomous: true
user_setup: []

must_haves:
  truths:
    - "LureList items have expandable annotation panels"
    - "Clicking 'Annotate' button toggles annotation form for that lure"
    - "Annotations persist to LocalStorage on every change"
    - "Removing a lure also removes its annotation from state"
  artifacts:
    - path: "src/components/LureList.tsx"
      provides: "Lure list with expandable annotation panels"
      contains: "AnnotationPanel"
    - path: "src/utils/storage.ts"
      provides: "LocalStorage utilities for annotations"
      exports: ["loadAnnotations", "saveAnnotations"]
    - path: "src/App.tsx"
      provides: "Annotation persistence and cleanup"
      contains: "saveAnnotations"
  key_links:
    - from: "src/components/LureList.tsx"
      to: "src/App.tsx"
      via: "Receive annotations and updateAnnotation props"
      pattern: "interface LureListProps"
    - from: "src/components/LureList.tsx"
      to: "src/components/AnnotationPanel.tsx"
      via: "Import and render AnnotationPanel"
      pattern: "import.*AnnotationPanel"
    - from: "src/App.tsx"
      to: "src/utils/storage.ts"
      via: "Import and call saveAnnotations in useEffect"
      pattern: "useEffect.*annotations.*saveAnnotations"
    - from: "src/App.tsx"
      to: "LocalStorage"
      via: "Persist annotations on every state change"
      pattern: "localStorage.*phishmonger-annotations"
---

<objective>
Integrate annotation UI with the LureList sidebar, add LocalStorage persistence for annotations, and wire up annotation cleanup when lures are removed.

Purpose: Complete the end-to-end annotation workflow: users can expand lure items to annotate them, changes persist across sessions, and deleting a lure cleans up its annotation.
Output: Fully functional technique annotation system integrated into the existing three-column layout.
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/STATE.md
@.planning/ROADMAP.md
@.planning/REQUIREMENTS.md
@.planning/phases/02-technique-annotations/02-RESEARCH.md
@.planning/phases/01-editor-foundation/01-07-SUMMARY.md
@.planning/phases/02-technique-annotations/02-01-SUMMARY.md
@.planning/phases/02-technique-annotations/02-02-SUMMARY.md
@src/components/LureList.tsx
@src/App.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create LocalStorage utility for annotations</name>
  <files>src/utils/storage.ts</files>
  <action>
    Create src/utils/storage.ts with utility functions for annotation persistence.

    Export these functions:
    ```typescript
    import type { Annotation } from '../types/annotations'

    const ANNOTATIONS_KEY = 'phishmonger-annotations'

    export const loadAnnotations = (): Record<string, Annotation> => {
      try {
        const saved = localStorage.getItem(ANNOTATIONS_KEY)
        return saved ? JSON.parse(saved) : {}
      } catch (error) {
        console.error('Failed to load annotations:', error)
        return {}
      }
    }

    export const saveAnnotations = (annotations: Record<string, Annotation>) => {
      try {
        localStorage.setItem(ANNOTATIONS_KEY, JSON.stringify(annotations))
      } catch (error) {
        console.error('Failed to save annotations:', error)
      }
    }
    ```

    Follow the pattern from 02-RESEARCH.md Pattern 3: LocalStorage Synchronization.

    Include proper error handling with try/catch blocks and console.error logging.

    Import Annotation type for type safety.
  </action>
  <verify>
    TypeScript compilation succeeds: `npx tsc --noEmit`. Functions are properly exported.
  </verify>
  <done>
    Storage utilities ready to persist and load annotations from LocalStorage.
  </done>
</task>

<task type="auto">
  <name>Task 2: Extend LureList with annotation panels</name>
  <files>src/components/LureList.tsx</files>
  <action>
    Extend LureList.tsx to show expandable annotation panels for each lure item.

    1. Import AnnotationPanel component:
       ```typescript
       import { AnnotationPanel } from './AnnotationPanel'
       import type { Annotation } from '../types/annotations'
       ```

    2. Add props for annotations:
       ```typescript
       interface LureListProps {
         htmlSource: string
         onRemoveLure: (lureId: string) => void
         annotations: Record<string, Annotation>
         onUpdateAnnotation: (lureId: string, updates: Partial<Annotation>) => void
       }
       ```

    3. Add expanded state:
       ```typescript
       const [expandedLureId, setExpandedLureId] = useState<string | null>(null)
       ```

    4. Update lure item rendering to include:
       - An "Annotate" toggle button (▶/▼) next to the remove button
       - Click handler: `onClick={() => setExpandedLureId(expandedLureId === lure.id ? null : lure.id)}`
       - Conditionally render AnnotationPanel when expanded:
         ```typescript
         {expandedLureId === lure.id && (
           <AnnotationPanel
             lureId={lure.id}
             lureText={lure.text}
             annotation={annotations[lure.id]}
             onUpdate={(updates) => onUpdateAnnotation(lure.id, updates)}
           />
         )}
         ```

    5. Update button layout in lure-list-item-content:
       - Keep existing scroll-to button
       - Add "Annotate" toggle button (▶ when collapsed, ▼ when expanded)
       - Keep existing remove button (×)

    Follow existing UI patterns from LureList.tsx (button classes, layout structure).

    Add CSS class annotation-toggle for the new button (matching lure-remove-btn styling).
  </action>
  <verify>
    TypeScript compilation succeeds: `npx tsc --noEmit`. Component has all required props.
  </verify>
  <done>
    LureList shows expandable annotation panels for each marked lure.
  </done>
</task>

<task type="auto">
  <name>Task 3: Wire persistence and cleanup in App.tsx</name>
  <files>src/App.tsx</files>
  <action>
    Complete annotation integration in App.tsx by adding persistence and cleanup.

    1. Import storage utilities:
       ```typescript
       import { loadAnnotations, saveAnnotations } from './utils/storage'
       ```

    2. Update annotations state initialization to use loadAnnotations():
       ```typescript
       const [annotations, setAnnotations] = useState<Record<string, Annotation>>(() => {
         return loadAnnotations()
       })
       ```

    3. Add useEffect for persistence after the existing htmlSource effect:
       ```typescript
       useEffect(() => {
         saveAnnotations(annotations)
       }, [annotations])
       ```

    4. Pass annotations and updateAnnotation to LureList:
       ```typescript
       <LureList
         htmlSource={htmlSource}
         onRemoveLure={handleRemoveLure}
         annotations={annotations}
         onUpdateAnnotation={updateAnnotation}
       />
       ```

    5. Update handleRemoveLure to also remove annotation:
       ```typescript
       const handleRemoveLure = (lureId: string) => {
         // ...existing HTML removal logic...

         // Remove annotation
         setAnnotations(prev => {
           const { [lureId]: removed, ...rest } = prev
           return rest
         })
       }
       ```

    This follows the cleanup pattern from 02-RESEARCH.md Pitfall 1 to prevent orphaned annotations.

    Ensure all state updates follow React best practices (functional updates for derived state).
  </action>
  <verify>
    TypeScript compilation succeeds: `npx tsc --noEmit`. Check that all props are passed correctly to LureList.
  </verify>
  <done>
    Annotations persist to LocalStorage and are cleaned up when lures are removed.
  </done>
</task>

</tasks>

<verification>
- LureList items show "Annotate" toggle button
- Clicking toggle expands/collapses AnnotationPanel
- Annotation changes save to LocalStorage immediately
- Reloading page restores previous annotations
- Removing a lure deletes its annotation from state and LocalStorage
- No orphaned annotations after lure deletion
</verification>

<success_criteria>
Complete annotation workflow working: users can expand lure items, select techniques, write explanations, changes persist, and cleanup works correctly.
</success_criteria>

<output>
After completion, create `.planning/phases/02-technique-annotations/02-03-SUMMARY.md`
</output>
