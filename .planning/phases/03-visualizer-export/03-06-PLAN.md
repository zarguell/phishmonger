---
phase: 03-visualizer-export
plan: 06
type: execute
wave: 3
depends_on: ["03-04"]
files_modified: [src/components/preview/ArrowOverlay.tsx, src/components/preview/SlideWrapper.tsx, src/index.css]
autonomous: true
user_setup: []

must_haves:
  truths:
    - "SVG overlay renders on top of slide with elbow-connector arrows"
    - "Arrows connect from lure right edge → bus line (x=1000) → card left edge"
    - "Arrows recalculate on window resize (debounced 200ms)"
    - "SVG has pointer-events: none to allow text selection underneath"
  artifacts:
    - path: "src/components/preview/ArrowOverlay.tsx"
      provides: "SVG overlay with elbow-connector arrows"
    - path: "src/components/preview/SlideWrapper.tsx"
      provides: "Slide wrapper with arrow overlay integration"
  key_links:
    - from: "ArrowOverlay.tsx"
      to: "useArrowCalculations"
      via: "ArrowPath type import"
      pattern: "import.*ArrowPath"
    - from: "SlideWrapper.tsx"
      to: "useArrowCalculations"
      via: "import and hook usage"
      pattern: "useArrowCalculations\\(.*\\)"
    - from: "SlideWrapper.tsx"
      to: "ArrowOverlay"
      via: "JSX component rendered after children"
      pattern: "<ArrowOverlay"
    - from: "SlideWrapper.tsx"
      to: "useDebouncedResize"
      via: "import and hook usage"
      pattern: "useDebouncedResize"
---

<objective>
Create SVG arrow overlay and integrate with SlideWrapper.

Purpose: Visualize connections between highlighted lures and their explanation cards through a shared vertical bus line (x=1000px).
Output: ArrowOverlay component and updated SlideWrapper with arrow overlay integration.
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/03-visualizer-export/03-CONTEXT.md
@.planning/phases/03-visualizer-export/03-RESEARCH.md

@src/components/preview/SlideWrapper.tsx
@src/components/preview/EmailColumn.tsx
@src/components/preview/AnnotationColumn.tsx
@src/types/annotations.ts

# Prior Phase 2-4 plans
@.planning/phases/02-technique-annotations/02-02-SUMMARY.md
@.planning/phases/03-visualizer-export/03-04-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Create ArrowOverlay SVG component</name>
  <files>src/components/preview/ArrowOverlay.tsx</files>
  <action>
    Create src/components/preview/ArrowOverlay.tsx:

    ```tsx
    import React from 'react'
    type { ArrowPath } from '../../hooks/useArrowCalculations'

    interface ArrowOverlayProps {
      paths: ArrowPath[]
    }

    export function ArrowOverlay({ paths }: ArrowOverlayProps) {
      return (
        <svg
          className="arrow-overlay"
          width="1600"
          height="100%"
          xmlns="http://www.w3.org/2000/svg"
        >
          <defs>
            <marker
              id="arrowhead"
              markerWidth="10"
              markerHeight="7"
              refX="10"
              refY="3.5"
              orient="auto"
            >
              <polygon points="0 0, 10 3.5, 0 7" fill="#FF4500" />
            </marker>
          </defs>
          {paths.map((path) => (
            <path
              key={path.lureId}
              d={`M ${path.start.x} ${path.start.y} L ${path.mid1.x} ${path.mid1.y} L ${path.mid2.x} ${path.mid2.y} L ${path.end.x} ${path.end.y}`}
              stroke="#FF4500"
              strokeWidth="2"
              fill="none"
              markerEnd="url(#arrowhead)"
            />
          ))}
        </svg>
      )
    }
    ```

    Why SVG overlay: Per Phase 3 Research, SVG is preferred over Canvas for overlays because it's DOM-like, easier to style with CSS, and handles dynamic path rendering efficiently.

    Why pointer-events: none: Per Phase 3 Research Pitfall 5, the overlay must not block text selection or clicks. CSS will set pointer-events: none on the arrow-overlay class.

    Why OrangeRed (#FF4500): Per Phase 3 Context, unified color creates clear visual hierarchy. Audience knows exactly where to look.

    Elbow connector path: M start L mid1 (horizontal to bus) L mid2 (vertical through bus) L end (horizontal to card).
  </action>
  <verify>test -f src/components/preview/ArrowOverlay.tsx && grep -q "arrow-overlay" src/components/preview/ArrowOverlay.tsx</verify>
  <done>ArrowOverlay component created with elbow-connector paths</done>
</task>

<task type="auto">
  <name>Update SlideWrapper to integrate arrow overlay</name>
  <files>src/components/preview/SlideWrapper.tsx</files>
  <action>
    Update src/components/preview/SlideWrapper.tsx to include arrow overlay:

    ```tsx
    import React, { useRef } from 'react'
    import { useArrowCalculations } from '../../hooks/useArrowCalculations'
    import { useDebouncedResize } from '../../hooks/useDebouncedResize'
    import { ArrowOverlay } from './ArrowOverlay'

    interface SlideWrapperProps {
      children: React.ReactNode
      annotations: Record<string, import('../../types/annotations').Annotation>
    }

    export function SlideWrapper({ children, annotations }: SlideWrapperProps) {
      const containerRef = useRef<HTMLDivElement>(null)
      const { arrowPaths, recalculate } = useArrowCalculations({
        containerRef,
        annotations,
      })

      // Recalculate arrows on window resize (debounced 200ms)
      useDebouncedResize(recalculate, 200)

      return (
        <div ref={containerRef} className="slide-wrapper">
          {children}
          <ArrowOverlay paths={arrowPaths} />
        </div>
      )
    }
    ```

    Changes:
    - Add useRef for container measurement
    - Import and use useArrowCalculations hook
    - Import and use useDebouncedResize hook
    - Render ArrowOverlay after children (z-index natural stacking)
    - Pass annotations to hook for path calculations

    Why ref on container: Per Phase 3 Research Pattern 1, all calculations must be relative to a stable container. The ref provides the DOM element for getBoundingClientRect() measurements.

    Why debounced resize: Window resize changes element positions, requiring arrow recalculation. Debouncing prevents excessive recalculations during active resizing.
  </action>
  <verify>grep -q "useArrowCalculations" src/components/preview/SlideWrapper.tsx && grep -q "ArrowOverlay" src/components/preview/SlideWrapper.tsx</verify>
  <done>SlideWrapper integrates arrow overlay with resize handling</done>
</task>

<task type="auto">
  <name>Add CSS for arrow overlay with pointer-events: none</name>
  <files>src/index.css</files>
  <action>
    Add CSS to src/index.css for arrow overlay:

    ```css
    /* Arrow Overlay */
    .arrow-overlay {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none; /* Allow text selection underneath */
      z-index: 10; /* Above content but below modals */
    }
    ```

    Why pointer-events: none: Per Phase 3 Research Pitfall 5, without this, the SVG overlay blocks all interactions with underlying content (text selection, clicks, etc.). Setting none allows clicks to pass through to the email and cards.

    Why z-index: 10: Ensures arrows appear above the email and cards, but below any modal overlays that might appear later.
  </action>
  <verify>grep -q "\.arrow-overlay" src/index.css && grep -q "pointer-events: none" src/index.css</verify>
  <done>CSS for arrow overlay added with pointer-events: none</done>
</task>

</tasks>

<verification>
- ArrowOverlay renders SVG with pointer-events: none
- Arrows follow elbow path: lure right → bus (x=1000) → card left
- Arrowhead marker points at annotation cards
- Arrows recalculate on window resize (debounced 200ms)
- SlideWrapper passes annotations to useArrowCalculations
- SVG has width 1600px matching slide wrapper
</verification>

<success_criteria>
- SVG overlay renders on top of slide without blocking interactions
- Elbow-connector arrows visually connect lures to their cards
- Arrows route through shared bus line at x=1000px
- Arrows track correctly on window resize
- Visual system ready for export (Plan 03-05)
</success_criteria>

<output>
After completion, create `.planning/phases/03-visualizer-export/03-06-SUMMARY.md`
</output>
