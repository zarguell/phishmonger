---
phase: 04-nist-phish-scale-scoring
plan: 02
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - src/App.tsx
  - src/utils/storage.ts
  - src/index.css
  - src/components/preview/SlideWrapper.tsx
  - src/components/export/ExportButton.tsx
autonomous: false
user_setup: []

must_haves:
  truths:
    - "ScoringPanel appears in edit mode alongside LureList and Preview"
    - "Scoring inputs persist to LocalStorage on change"
    - "Difficulty badge appears on preview slide in bottom-right corner"
    - "Exported PNG includes badge"
  artifacts:
    - path: "src/App.tsx"
      provides: "Scoring state management, LocalStorage persistence, panel integration"
      exports: []
      min_lines: 300
    - path: "src/components/preview/SlideWrapper.tsx"
      provides: "Badge overlay rendering on slide"
      exports: ["SlideWrapper"]
      min_lines: 30
    - path: "src/components/export/ExportButton.tsx"
      provides: "PNG export functionality"
      exports: ["ExportButton"]
    - path: "src/utils/storage.ts"
      provides: "LocalStorage persistence for scoring data"
      exports: ["loadScoring", "saveScoring"]
  key_links:
    - from: "src/App.tsx"
      to: "src/components/ScoringPanel.tsx"
      via: "import and render ScoringPanel with state"
      pattern: "import.*ScoringPanel"
    - from: "src/App.tsx"
      to: "src/types/scoring.ts"
      via: "import ScoringData for state type"
      pattern: "import.*ScoringData"
    - from: "src/components/preview/SlideWrapper.tsx"
      to: "src/utils/scoring.ts"
      via: "import getDifficultyBadge for rendering"
      pattern: "import.*scoring"
    - from: "src/App.tsx"
      to: "src/components/preview/SlideWrapper.tsx"
      via: "pass scoring data with showBadge hardcoded to true"
      pattern: "scoring"
---

<objective>
Integrate ScoringPanel into App.tsx with LocalStorage persistence, add difficulty badge overlay to SlideWrapper, and hardcode badge visibility for export.

Purpose: Connect scoring component to application state, persist user inputs, display badge on exported slides. Badge visibility toggle deferred to Phase 5.
Output: Working scoring UI with persistence and badge display on preview and export.
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-nist-phish-scale-scoring/04-CONTEXT.md
@src/App.tsx
@src/components/ScoringPanel.tsx
@src/types/scoring.ts
@src/utils/scoring.ts
@src/components/preview/SlideWrapper.tsx
@src/components/export/ExportButton.tsx
@src/index.css
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add scoring state and ScoringPanel to App.tsx</name>
  <files>src/App.tsx</files>
  <action>
    Modify App.tsx to integrate scoring:

    1. Add imports at top:
    ```typescript
    import { ScoringPanel } from './components/ScoringPanel'
    import type { ScoringData } from './types/scoring'
    import { loadScoring, saveScoring } from './utils/storage'
    ```

    2. Add constants after existing constants:
    ```typescript
    const SCORING_KEY = 'phishmonger-scoring'
    ```

    3. Add scoring state in App component (after annotations state):
    ```typescript
    const [scoring, setScoring] = useState<ScoringData>(() => {
      return loadScoring()
    })
    ```

    4. Add persistence useEffect (after annotations persistence):
    ```typescript
    // Save scoring to LocalStorage
    useEffect(() => {
      saveScoring(scoring)
    }, [scoring])
    ```

    5. Add scoring update handler (after updateAnnotation handler):
    ```typescript
    const updateScoring = (updates: Partial<ScoringData>) => {
      setScoring(prev => ({
        ...prev,
        ...updates
      }))
    }
    ```

    6. Modify App.tsx layout to include ScoringPanel:
    Change the main edit mode section from three columns to include scoring:
    ```typescript
    return (
      <div className="app">
        <header className="app-header">
          <h1>Phish Monger</h1>
          <p>Phishing Email Annotation Tool</p>
          <div className="header-actions">
            <button
              onClick={() => setViewMode('preview')}
              className="preview-mode-button"
              type="button"
              disabled={Object.keys(annotations).length === 0}
            >
              Preview Mode
            </button>
          </div>
        </header>
        <main className="app-main">
          <div className="input-column">
            <div className="mode-toggle">
              {/* existing mode toggle code */}
            </div>
            {inputMode === 'html' ? (
              <HTMLInput
                value={htmlSource}
                onChange={setHtmlSource}
              />
            ) : (
              <Editor
                content={htmlSource}
                onUpdate={setHtmlSource}
              />
            )}
          </div>
          <div className="preview-column">
            <Preview
              htmlSource={htmlSource}
              onUpdate={handleMarkLure}
            />
          </div>
          <div className="lure-list-column">
            <LureList
              htmlSource={htmlSource}
              onRemoveLure={handleRemoveLure}
              annotations={annotations}
              onUpdateAnnotation={updateAnnotation}
            />
          </div>
          <div className="scoring-column">
            <ScoringPanel
              scoring={scoring}
              onUpdate={updateScoring}
            />
          </div>
        </main>
      </div>
    )
    ```

    7. Update preview mode header to include scoring data for export:
    ```typescript
    <ExportButton
      slideWrapperRef={slideWrapperRef}
      projectTitle="phish-analysis"
      scoring={scoring}
    />
    ```

    Do NOT modify preview mode SlideWrapper props yet (task 2 will handle badge).
    Follow existing patterns for state management and persistence.
    Use four-column layout (input, preview, lure list, scoring).
  </action>
  <verify>
    Check imports added:
    - grep -n "import.*ScoringPanel\|import.*ScoringData\|import.*loadScoring" src/App.tsx

    Verify TypeScript compiles:
    - npm run build (no type errors)
  </verify>
  <done>
    App.tsx includes:
    - Scoring state with LocalStorage persistence
    - ScoringPanel rendered in fourth column
    - updateScoring handler for input changes
    - Scoring passed to ExportButton (for badge visibility in next task)
  </done>
</task>

<task type="auto">
  <name>Task 2: Add scoring storage utility functions</name>
  <files>src/utils/storage.ts</files>
  <action>
    Modify src/utils/storage.ts to add scoring persistence:

    1. Add scoring type import at top:
    ```typescript
    import type { ScoringData } from '../types/scoring'
    ```

    2. Add loadScoring function (after existing load functions):
    ```typescript
    /**
     * Load scoring data from LocalStorage
     */
    export function loadScoring(): ScoringData {
      try {
        const saved = localStorage.getItem('phishmonger-scoring')
        if (saved) {
          const parsed = JSON.parse(saved)
          return {
            visualCues: parsed.visualCues ?? 0,
            languageCues: parsed.languageCues ?? 0,
            premiseAlignment: parsed.premiseAlignment ?? 3
          }
        }
      } catch (error) {
        console.error('Failed to load scoring:', error)
      }
      return {
        visualCues: 0,
        languageCues: 0,
        premiseAlignment: 3
      }
    }
    ```

    3. Add saveScoring function (after existing save functions):
    ```typescript
    /**
     * Save scoring data to LocalStorage
     */
    export function saveScoring(scoring: ScoringData): void {
      try {
        localStorage.setItem('phishmonger-scoring', JSON.stringify(scoring))
      } catch (error) {
        console.error('Failed to save scoring:', error)
      }
    }
    ```

    Follow existing patterns for error handling and JSON parsing.
    Use sensible defaults: visualCues=0, languageCues=0, premiseAlignment=3 (neutral).
  </action>
  <verify>
    Check functions added:
    - grep -n "export function loadScoring\|export function saveScoring" src/utils/storage.ts

    Verify TypeScript compiles:
    - npm run build (no type errors)
  </verify>
  <done>
    storage.ts exports loadScoring and saveScoring functions
    Functions follow existing patterns with error handling
    Default values match scoring data structure
  </done>
</task>

<task type="auto">
  <name>Task 3: Update App layout CSS for four columns</name>
  <files>src/index.css</files>
  <action>
    Modify src/index.css to support four-column layout:

    Find the `.app-main` grid definition and update:
    ```css
    .app-main {
      display: grid;
      grid-template-columns: 1fr 1fr 300px 280px; /* Added fourth column for scoring */
      gap: 1.5rem;
      align-items: start;
    }
    ```

    Add scoring column styles (after existing column styles):
    ```css
    .scoring-column {
      display: flex;
      flex-direction: column;
      gap: 1rem;
      max-height: calc(100vh - 200px);
      overflow-y: auto;
    }
    ```

    Keep existing column styles unchanged (input-column, preview-column, lure-list-column).
    Use 280px for scoring column (slightly narrower than lure list's 300px).
  </action>
  <verify>
    Check layout updated:
    - grep -A 3 "grid-template-columns" src/index.css

    Verify CSS compiles:
    - npm run build (no CSS errors)
  </verify>
  <done>
    .app-main grid updated to four columns
    .scoring-column styles added for layout
    Scoring panel fits in fourth column without overflow
  </done>
</task>

<task type="auto">
  <name>Task 4: Add difficulty badge to SlideWrapper and connect scoring</name>
  <files>src/components/preview/SlideWrapper.tsx, src/index.css, src/App.tsx</files>
  <action>
    Add badge component to SlideWrapper and wire it in App.tsx:

    **src/components/preview/SlideWrapper.tsx:**
    Modify component to accept scoring and showBadge props, render badge overlay:
    ```typescript
    import React, { useRef, forwardRef } from 'react'
    import type { ScoringData } from '../../types/scoring'
    import { calculateDifficulty, getDifficultyLevel, getDifficultyBadge } from '../../utils/scoring'

    interface SlideWrapperProps {
      children: React.ReactNode
      annotations: Record<string, import('../../types/annotations').Annotation>
      scoring?: ScoringData
      showBadge?: boolean
    }

    export const SlideWrapper = forwardRef<HTMLDivElement, SlideWrapperProps>(
      ({ children, scoring, showBadge = true }, ref) => {
        const internalRef = useRef<HTMLDivElement>(null)
        const containerRef = (ref as React.RefObject<HTMLDivElement>) || internalRef

        // Calculate difficulty if scoring provided
        let badge: { letter: string, color: string } | null = null
        if (scoring && showBadge) {
          const score = calculateDifficulty(scoring)
          const level = getDifficultyLevel(score)
          const badgeData = getDifficultyBadge(level)
          badge = { letter: badgeData.letter, color: badgeData.color }
        }

        return (
          <div ref={containerRef} className="slide-wrapper">
            {children}
            {badge && (
              <div className="difficulty-badge-overlay" style={{ backgroundColor: badge.color }}>
                {badge.letter}
              </div>
            )}
          </div>
        )
      }
    )

    SlideWrapper.displayName = 'SlideWrapper'
    ```

    **src/index.css:**
    Add badge overlay styles:
    ```css
    .difficulty-badge-overlay {
      position: absolute;
      bottom: 20px;
      right: 20px;
      width: 80px;
      height: 80px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 2.5rem;
      font-weight: bold;
      color: white;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
      z-index: 10;
    }
    ```
    Ensure .slide-wrapper has position: relative (check existing CSS, add if missing).

    **src/App.tsx:**
    Wire scoring data to SlideWrapper in preview mode:
    Find the SlideWrapper usage and update props:
    ```typescript
    <SlideWrapper
      ref={slideWrapperRef}
      annotations={annotations}
      scoring={scoring}
      showBadge={true}
    >
      <EmailColumn htmlSource={htmlSource} annotations={annotations} />
      <AnnotationColumn
        annotations={annotations}
        width={annotationWidth}
      />
    </SlideWrapper>
    ```

    Hardcode showBadge=true for this phase (toggle deferred to Phase 5).
    Position badge in bottom-right corner per CONTEXT.md decision.
    Use 80px badge size for visibility on exported slide.
  </action>
  <verify>
    Check badge component added:
    - grep -n "difficulty-badge-overlay" src/components/preview/SlideWrapper.tsx

    Check scoring wired in App.tsx:
    - grep -A 5 "SlideWrapper" src/App.tsx | grep -E "scoring|showBadge"

    Verify TypeScript compiles:
    - npm run build (no type errors)

    Check styles added:
    - grep -A 10 "difficulty-badge-overlay" src/index.css
  </verify>
  <done>
    SlideWrapper accepts scoring and showBadge props
    Badge renders in bottom-right corner when showBadge=true
    Badge displays correct letter (E/M/H) and color based on calculation
    App.tsx passes scoring prop to SlideWrapper with showBadge=true
    Badge appears in preview mode and exported PNG
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete NIST Phish Scale scoring system with:
- ScoringPanel in edit mode with counter widgets and slider
- LocalStorage persistence for scoring inputs
- Difficulty badge overlay on preview slides
- Exported PNG includes badge</what-built>
  <how-to-verify>
    1. Start the dev server: npm run dev
    2. Open http://localhost:5173 in browser
    3. Verify ScoringPanel appears in fourth column in edit mode
    4. Test counter widgets: Click + buttons to increment visual cues (0→1→2) and language cues
    5. Test slider: Drag premise alignment slider and verify value changes (1-5)
    6. Observe score breakdown updates (badge color changes: Green≥3, Yellow 1-2, Red≤0)
    7. Click "Preview Mode" button
    8. Verify difficulty badge appears in bottom-right corner of slide with correct letter
    9. Click "Export PNG" and verify badge appears in exported image
    10. Refresh page and verify scoring inputs persist (counter values, slider position)
  </how-to-verify>
  <resume-signal>Type "approved" or describe any issues</resume-signal>
</task>

</tasks>

<verification>
After all tasks complete (before checkpoint):

1. Verify TypeScript compiles: `npm run build` (no type errors)
2. Verify ScoringPanel integration: `grep -n "ScoringPanel" src/App.tsx`
3. Verify scoring persistence: `grep -n "loadScoring\|saveScoring" src/App.tsx`
4. Verify badge overlay: `grep -n "difficulty-badge-overlay" src/components/preview/SlideWrapper.tsx`
</verification>

<success_criteria>
1. ScoringPanel renders in edit mode with functional counter widgets and slider
2. Scoring inputs persist to LocalStorage and restore on page reload
3. Difficulty badge appears on preview slide in bottom-right corner
4. Badge displays correct letter (E/M/H) and color based on calculation
5. Badge appears in exported PNG (showBadge hardcoded to true)
6. Four-column layout works correctly in edit mode
</success_criteria>

<output>
After completion, create `.planning/phases/04-nist-phish-scale-scoring/04-02-SUMMARY.md`
</output>
