---
phase: 15-dependency-upgrades-polish
plan: 03
type: execute
wave: 3
depends_on: [15-02]
files_modified:
  - package.json
  - package-lock.json
  - src/extensions/LureMark.ts
autonomous: false

must_haves:
  truths:
    - "Tiptap monorepo upgraded to v3.17.0"
    - "LureMark extension migrated to v3 API (function-based defaults)"
    - "LureMark creation works in editor (add lure button)"
    - "LureMark rendering works in visualizer (badge overlay)"
    - "LureMark persistence works (save/load JSON)"
    - "No Tiptap-related console errors"
  artifacts:
    - path: "package.json"
      provides: "Tiptap version declarations"
      contains: '"@tiptap/core": "^3.17.0"'
    - path: "src/extensions/LureMark.ts"
      provides: "Custom Tiptap node extension"
      contains: "addAttributes.*default.*() =>"
    - path: "src/components/Editor.tsx"
      provides: "Editor component using Tiptap"
      contains: "useEditor|@tiptap/react"
  key_links:
    - from: "src/components/Editor.tsx"
      to: "@tiptap/core@3.17.0"
      via: "TiptapEditor initialization"
      pattern: "useEditor.*@tiptap"
    - from: "src/extensions/LureMark.ts"
      to: "@tiptap/core@3.17.0"
      via: "Node.create() extension API"
      pattern: "import.*@tiptap/core"
---

<objective>
Upgrade Tiptap to v3.17.0 and migrate LureMark extension to v3 API.

Purpose: Tiptap v3 requires extension API changes (function-based defaults). The LureMark extension is simple (single attribute with uuid generation), so migration is straightforward.
Output: Modern Tiptap v3 with LureMark extension working correctly.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/phases/15-dependency-upgrades-polish/15-RESEARCH.md
@.planning/phases/15-dependency-upgrades-polish/15-CONTEXT.md
@.planning/PROJECT.md
@.planning/ROADMAP.md
@package.json
@src/extensions/LureMark.ts
@src/components/Editor.tsx
</context>

<tasks>

<task type="auto">
  <name>Upgrade Tiptap monorepo to v3.17.0</name>
  <files>package.json</files>
  <action>
    1. Install all Tiptap packages at v3.17.0:
       npm install @tiptap/core@^3.17.0 @tiptap/react@^3.17.0 @tiptap/starter-kit@^3.17.0 @tiptap/extension-link@^3.17.0 @tiptap/pm@^3.17.0

    2. Verify package.json shows all Tiptap packages at v3.17.0

    Note: Tiptap v3 removed internal uuid dependency. Extensions should use crypto.randomUUID() or the uuid package (already in dependencies).
  </action>
  <verify>grep -E '"@tiptap/core".*"3\.17\.0"' package.json && npm list @tiptap/core | grep 3.17.0</verify>
  <done>All Tiptap packages at v3.17.0</done>
</task>

<task type="auto">
  <name>Migrate LureMark extension to Tiptap v3 API</name>
  <files>src/extensions/LureMark.ts</files>
  <action>
    Update src/extensions/LureMark.ts for Tiptap v3 compatibility:

    1. Change the default value in addAttributes from static to function-based:
       BEFORE: default: uuidv4()
       AFTER: default: () => uuidv4()

    2. Keep the uuid import (uuid package is already in dependencies)

    The updated addAttributes should be:
    ```typescript
    addAttributes() {
      return {
        lureId: {
          default: () => uuidv4(),
        },
      }
    },
    ```

    Rationale: Tiptap v3 requires function-based defaults to avoid sharing state between instances.
  </action>
  <verify>grep -q "default: () => uuidv4()" src/extensions/LureMark.ts && npx tsc --noEmit</verify>
  <done>LureMark extension uses function-based defaults, TypeScript compiles</done>
</task>

<task type="auto">
  <name>Verify LureMark compilation and basic functionality</name>
  <files>src/components/Editor.tsx</files>
  <action>
    1. Run TypeScript compiler: npx tsc --noEmit
    2. Start dev server: npm run dev (allow 10 seconds, then Ctrl+C)
    3. Check for Tiptap-related console errors
    4. Run production build: npm run build

    Expected: Zero TypeScript errors, dev server starts without Tiptap errors, production build succeeds.
  </action>
  <verify>npx tsc --noEmit && npm run build && echo "Build successful"</verify>
  <done>TypeScript compiles, dev server starts, production build succeeds</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Tiptap v3 upgrade with LureMark extension migrated to v3 API</what-built>
  <how-to-verify>
    1. Start dev server: npm run dev
    2. Open browser to http://localhost:5173
    3. Test LureMark creation workflow:
       - Type some text in the email content editor
       - Click "Add Lure" button
       - Verify a lure badge appears in the editor (highlighted text)
       - Add an annotation for the lure
       - Verify the annotation card appears
    4. Test visualizer rendering:
       - Switch to preview mode
       - Verify numbered badge overlay appears on the email
       - Verify technique explanation cards display
    5. Test persistence:
       - Export project as JSON
       - Reload page and import the JSON
       - Verify lures are preserved

    Expected: All LureMark workflows work identically to before the upgrade.
  </how-to-verify>
  <resume-signal>Type "approved" if LureMark works correctly, or describe any issues</resume-signal>
</task>

</tasks>

<verification>
After completing all tasks:
1. package.json contains all Tiptap packages at ^3.17.0
2. src/extensions/LureMark.ts uses function-based defaults
3. TypeScript compilation passes (npx tsc --noEmit)
4. Dev server starts without Tiptap-related errors
5. LureMark creation works (verified via checkpoint)
6. LureMark rendering works (verified via checkpoint)
7. LureMark persistence works (verified via checkpoint)
</verification>

<success_criteria>
- Tiptap upgraded to v3.17.0
- LureMark extension migrated to v3 API
- All LureMark workflows (create, render, persist) work correctly
- No console errors related to Tiptap
</success_criteria>

<output>
After completion, create `.planning/phases/15-dependency-upgrades-polish/15-03-SUMMARY.md`
</output>
