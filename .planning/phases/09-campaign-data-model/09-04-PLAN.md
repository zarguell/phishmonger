---
phase: 09-campaign-data-model
plan: 04
type: execute
wave: 2
depends_on:
  - 09-01
files_modified:
  - src/utils/storageQuota.ts
  - src/App.tsx
autonomous: true

must_haves:
  truths:
    - "getStorageUsage() returns bytes used by LocalStorage"
    - "getStoragePercentage() returns usage percentage (0-100)"
    - "isStorageNearQuota() returns true when usage > 80%"
    - "isStorageAtQuota() returns true when usage > 95%"
    - "App.tsx initializes schema version on mount via initializeSchema()"
    - "Storage quota warnings appear when campaigns exceed quota limits"
  artifacts:
    - path: "src/utils/storageQuota.ts"
      provides: "LocalStorage quota monitoring utilities"
      exports: ["getStorageUsage", "getStoragePercentage", "isStorageNearQuota", "isStorageAtQuota"]
      min_lines: 40
  key_links:
    - from: "src/utils/storageQuota.ts"
      to: "localStorage"
      via: "Object.entries(localStorage) iteration"
      pattern: "Object.entries.*localStorage"
    - from: "src/App.tsx"
      to: "src/utils/schemaVersion.ts"
      via: "import initializeSchema"
      pattern: "import.*initializeSchema"
    - from: "src/App.tsx"
      to: "src/utils/storageQuota.ts"
      via: "import getStoragePercentage, isStorageNearQuota"
      pattern: "import.*getStoragePercentage.*isStorageNearQuota"
---

<objective>
Storage quota monitoring and warning system with schema initialization.

Purpose: Monitor LocalStorage usage and warn users before hitting the ~5MB browser limit. Use try-catch quota detection with inline error state (not toast notifications per RESEARCH.md). Initialize schema version on app mount for future migration support.
Output: Storage quota utilities and schema initialization in App.tsx with inline error display for quota issues.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/STATE.md
@.planning/ROADMAP.md
@.planning/phases/09-campaign-data-model/09-CONTEXT.md
@.planning/phases/09-campaign-data-model/09-RESEARCH.md
@.planning/phases/09-campaign-data-model/09-01-SUMMARY.md
@.planning/phases/09-campaign-data-model/09-02-SUMMARY.md

@src/App.tsx
@src/utils/schemaVersion.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create storage quota monitoring utilities</name>
  <files>src/utils/storageQuota.ts</files>
  <action>
    Create src/utils/storageQuota.ts with quota monitoring utilities:

    ```typescript
    /**
     * LocalStorage quota monitoring for Phish Monger
     *
     * Browser LocalStorage has a ~5MB limit per origin. This module
     * provides utilities to monitor usage and warn users before they
     * hit the limit.
     *
     * Quota thresholds per CONTEXT.md:
     * - Warn at 80% (~4MB used)
     * - Error at 95% (~4.75MB used)
     *
     * Note: Storage is calculated by measuring actual LocalStorage content,
     * not by pre-calculating. This handles different browser implementations.
     */

    /** Approximate LocalStorage quota in bytes (5MB is typical) */
    const QUOTA_BYTES = 5 * 1024 * 1024;

    /** Warn threshold: 80% of quota */
    const WARN_THRESHOLD = 0.8;

    /** Error threshold: 95% of quota */
    const ERROR_THRESHOLD = 0.95;

    /**
     * Calculate current LocalStorage usage in bytes
     *
     * Sums the length of all keys and values in LocalStorage.
     * Each character is 2 bytes in UTF-16 (JavaScript string encoding).
     *
     * @returns Bytes used by LocalStorage
     */
    export function getStorageUsage(): number {
      let total = 0;
      for (const [key, value] of Object.entries(localStorage)) {
        // Key + value length, times 2 for UTF-16 encoding
        total += (key.length + value.length) * 2;
      }
      return total;
    }

    /**
     * Get storage usage as a percentage of quota
     *
     * @returns Usage percentage (0-100)
     */
    export function getStoragePercentage(): number {
      const usage = getStorageUsage();
      return Math.min(100, (usage / QUOTA_BYTES) * 100);
    }

    /**
     * Check if storage is near quota limit (warning threshold)
     *
     * Returns true when usage exceeds 80% of quota.
     *
     * @returns true if storage usage > 80%
     */
    export function isStorageNearQuota(): boolean {
      return getStoragePercentage() > WARN_THRESHOLD * 100;
    }

    /**
     * Check if storage is at quota limit (error threshold)
     *
     * Returns true when usage exceeds 95% of quota.
     *
     * @returns true if storage usage > 95%
     */
    export function isStorageAtQuota(): boolean {
      return getStoragePercentage() > ERROR_THRESHOLD * 100;
    }

    /**
     * Format bytes as human-readable string (e.g., "4.2 MB")
     *
     * @param bytes - Bytes to format
     * @returns Formatted string
     */
    export function formatBytes(bytes: number): string {
      const mb = bytes / (1024 * 1024);
      if (mb >= 1) {
        return `${mb.toFixed(1)} MB`;
      }
      const kb = bytes / 1024;
      return `${kb.toFixed(0)} KB`;
    }
    ```

    Key decisions from CONTEXT.md:
    - Use try-catch quota detection, not pre-validation
    - Warn at 80% (~4MB), error at 95% (~4.75MB)
    - Calculate by measuring actual LocalStorage content
    - Use inline error state (not toast notifications)

    DO NOT use compression libraries or auto-delete features per CONTEXT.md.
  </action>
  <verify>test -f src/utils/storageQuota.ts && grep -q "getStorageUsage" src/utils/storageQuota.ts && grep -q "isStorageNearQuota" src/utils/storageQuota.ts</verify>
  <done>Storage quota utilities created with usage calculation and threshold checking</done>
</task>

<task type="auto">
  <name>Task 2: Initialize schema version in App.tsx</name>
  <files>src/App.tsx</files>
  <action>
    Add schema initialization to App.tsx on mount:

    1. Import at the top of the file:
       ```typescript
       import { initializeSchema } from './utils/schemaVersion';
       ```

    2. Add initializeSchema call in the App component (inside main component, before return):
       ```typescript
       useEffect(() => {
         initializeSchema();
       }, []);
       ```

    This ensures the schema version is set to 2 on first run and establishes
    the pattern for future migrations.

    Look for existing useEffect hooks in App.tsx and add this near the top
    of the hook list, or create a new useEffect if none exist.

    Note: You may need to import useEffect if not already imported.
  </action>
  <verify>grep -q "initializeSchema" src/App.tsx && grep -q "import.*initializeSchema" src/App.tsx</verify>
  <done>Schema version initialized on app mount via initializeSchema()</done>
</task>

<task type="auto">
  <name>Task 3: Add storage quota monitoring display to App.tsx</name>
  <files>src/App.tsx</files>
  <action>
    Add storage quota warning display to App.tsx:

    1. Import storage quota utilities:
       ```typescript
       import { getStoragePercentage, isStorageNearQuota, formatBytes } from './utils/storageQuota';
       ```

    2. Add state for storage percentage (after other useState declarations):
       ```typescript
       const [storagePercent, setStoragePercent] = useState<number>(0);
       ```

    3. Add useEffect to monitor storage (after initializeSchema useEffect):
       ```typescript
       useEffect(() => {
         // Update storage percentage on LocalStorage changes
         const updateStorage = () => {
           setStoragePercent(getStoragePercentage());
         };

         // Initial check
         updateStorage();

         // Listen for storage events (changes in other tabs)
         window.addEventListener('storage', updateStorage);
         return () => window.removeEventListener('storage', updateStorage);
       }, []);
       ```

    4. Add warning banner in the JSX (near the top of the app, inside main container):
       ```tsx
       {isStorageNearQuota() && (
         <div className="bg-amber-50 border-b border-amber-200 px-4 py-2 text-amber-900 text-sm">
           <strong>Storage Warning:</strong> Using {storagePercent.toFixed(0)}% of available storage.
           Delete old campaigns or export data to free up space.
         </div>
       )}
       ```

    This provides inline error state (not toast) as specified in RESEARCH.md.

    Look for existing app header or container structure to place the warning
    banner appropriately. The warning should be visible but not intrusive.
  </action>
  <verify>grep -q "isStorageNearQuota" src/App.tsx && grep -q "getStoragePercentage" src/App.tsx && grep -q "storagePercent" src/App.tsx</verify>
  <done>Storage quota warning banner displays when usage exceeds 80%</done>
</task>

</tasks>

<verification>
1. Check that getStorageUsage() returns non-zero bytes when LocalStorage has data
2. Check that getStoragePercentage() returns percentage between 0-100
3. Check that isStorageNearQuota() returns true when usage > 80%
4. Check that initializeSchema() is called on app mount
5. Check that warning banner appears when storage is near quota
6. Add some data to LocalStorage and verify the percentage updates
</verification>

<success_criteria>
- Storage quota monitoring utilities calculate usage correctly
- Warning banner displays when storage exceeds 80% threshold
- Schema version is initialized on app mount
- Quota detection uses try-catch pattern (actual measurement, not pre-validation)
- Warning display uses inline error state (not toast notifications)
</success_criteria>

<output>
After completion, create `.planning/phases/09-campaign-data-model/09-04-SUMMARY.md`
</output>
