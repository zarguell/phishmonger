---
phase: 01-editor-foundation
plan: 03
type: execute
wave: 3
depends_on: ["01-02"]
files_modified: [src/components/Editor.tsx, src/App.tsx, src/index.css]
autonomous: true
user_setup: []

must_haves:
  truths:
    - "Editor component renders with formatting toolbar"
    - "Editor uses Lure Mark extension to wrap text"
    - "Editor sanitizes pasted HTML content"
    - "Editor content saves to LocalStorage on change"
    - "Editor content loads from LocalStorage on mount"
    - "Lure Marks with UUIDs persist across page reloads"
  artifacts:
    - path: "src/components/Editor.tsx"
      provides: "Tiptap editor component with toolbar and extensions"
      exports: ["Editor"]
      contains: "useEditor", "LureMark", "sanitizeHtml"
    - path: "src/App.tsx"
      provides: "Main app with Editor and Lure Mark button"
      contains: "Editor", "useState", "useEffect", "localStorage"
    - path: "src/index.css"
      provides: "Styling for editor and Lure Mark highlights"
      contains: ".lure-mark", ".ProseMirror"
  key_links:
    - from: "src/components/Editor.tsx"
      to: "src/extensions/LureMark.ts"
      via: "LureMark import"
      pattern: "import.*LureMark.*from.*extensions/LureMark"
    - from: "src/components/Editor.tsx"
      to: "src/utils/sanitizeHtml.ts"
      via: "sanitizeHtml import"
      pattern: "import.*sanitizeHtml.*from.*utils/sanitizeHtml"
    - from: "src/App.tsx"
      to: "src/components/Editor.tsx"
      via: "Editor component usage"
      pattern: "import.*Editor.*from.*components/Editor"
    - from: "src/App.tsx"
      to: "localStorage"
      via: "useEffect hooks for save/load"
      pattern: "useEffect.*localStorage|localStorage\\.getItem|localStorage\\.setItem"
---

<objective>
Create the Editor component integrating Tiptap with Lure Mark extension and HTML sanitization, plus the main app UI with toolbar and LocalStorage persistence.

Purpose: This is the core user-facing feature - the editor where users compose phishing email content and mark deceptive techniques. It brings together the Lure Mark extension and sanitization logic, with LocalStorage persistence so work is saved automatically.

Output:
- Editor.tsx: Tiptap editor with toolbar (bold, italic, links, Lure Mark button)
- App.tsx: Main app with Editor component and LocalStorage save/load
- index.css: Styling for editor and yellow Lure Mark highlights
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/STATE.md
@.planning/ROADMAP.md
@.planning/REQUIREMENTS.md
@.planning/phases/01-editor-foundation/01-01-SUMMARY.md
@.planning/phases/01-editor-foundation/01-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Create Editor component with Tiptap, Lure Mark, and sanitization</name>
  <files>src/components/Editor.tsx</files>
  <action>
    Create src/components/Editor.tsx:

    ```typescript
    import { useEditor, EditorContent } from '@tiptap/react'
    import StarterKit from '@tiptap/starter-kit'
    import Link from '@tiptap/extension-link'
    import { LureMark } from '../extensions/LureMark'
    import { sanitizeHtml } from '../utils/sanitizeHtml'

    interface EditorProps {
      content?: string
      onUpdate?: (content: string) => void
    }

    export function Editor({ content = '', onUpdate }: EditorProps) {
      const editor = useEditor({
        extensions: [
          StarterKit,
          Link.configure({
            openOnClick: false,
            HTMLAttributes: {
              target: '_blank',
              rel: 'noopener noreferrer',
            },
          }),
          LureMark,
        ],
        content,
        editorProps: {
          attributes: {
            class: 'prose prose-sm sm:prose lg:prose-lg xl:prose-xl focus:outline-none max-w-none',
          },
          handlePaste: (view, event) => {
            event.preventDefault()
            const html = event.clipboardData?.getData('text/html') || ''
            const text = event.clipboardData?.getData('text/plain') || ''

            const sanitized = html ? sanitizeHtml(html) : text
            const { from } = view.state.selection
            view.dispatch(
              view.state.tr.insertText(sanitized, from)
            )
            return true
          },
        },
        onUpdate: ({ editor }) => {
          onUpdate?.(editor.getHTML())
        },
      })

      if (!editor) {
        return null
      }

      return (
        <div className="editor-container">
          <div className="editor-toolbar">
            <button
              onClick={() => editor.chain().focus().toggleBold().run()}
              disabled={!editor.can().chain().focus().toggleBold().run()}
              className={`toolbar-btn ${editor.isActive('bold') ? 'is-active' : ''}`}
            >
              Bold
            </button>
            <button
              onClick={() => editor.chain().focus().toggleItalic().run()}
              disabled={!editor.can().chain().focus().toggleItalic().run()}
              className={`toolbar-btn ${editor.isActive('italic') ? 'is-active' : ''}`}
            >
              Italic
            </button>
            <button
              onClick={() => editor.chain().focus().toggleLink({ href: prompt('Enter URL:') || '' }).run()}
              disabled={!editor.can().chain().focus().toggleLink().run()}
              className={`toolbar-btn ${editor.isActive('link') ? 'is-active' : ''}`}
            >
              Link
            </button>
            <div className="toolbar-divider" />
            <button
              onClick={() => {
                const { from, to } = editor.state.selection
                const lureId = crypto.randomUUID()
                editor
                  .chain()
                  .focus()
                  .setMark('lureMark', { lureId })
                  .run()
              }}
              disabled={editor.state.selection.empty}
              className="toolbar-btn toolbar-btn-lure"
            >
              Mark Lure
            </button>
          </div>
          <EditorContent editor={editor} className="editor-content" />
        </div>
      )
    }
    ```

    Key features:
    - Tiptap editor with StarterKit (basic formatting) and Link extension
    - LureMark extension integrated
    - Paste handler intercepts clipboard, sanitizes HTML, strips dangerous content
    - Toolbar with Bold, Italic, Link buttons
    - "Mark Lure" button wraps selected text in Lure Mark with UUID
    - Updates parent component on content change
  </action>
  <verify>
    Check that src/components/Editor.tsx exists and exports Editor component.
    Verify imports: useEditor, EditorContent from @tiptap/react; LureMark from extensions; sanitizeHtml from utils.
    Confirm toolbar has Bold, Italic, Link, Mark Lure buttons.
  </verify>
  <done>
    Editor component with Tiptap, Lure Mark extension, and HTML sanitization is created.
  </done>
</task>

<task type="auto">
  <name>Create main App component with Editor and LocalStorage</name>
  <files>src/App.tsx</files>
  <action>
    Replace src/App.tsx with:

    ```typescript
    import { useState, useEffect } from 'react'
    import { Editor } from './components/Editor'
    import './index.css'

    const STORAGE_KEY = 'phishmonger-editor-content'

    function App() {
      const [content, setContent] = useState(() => {
        // Load from LocalStorage on mount
        const saved = localStorage.getItem(STORAGE_KEY)
        return saved || '<p>Start typing your phishing email here...</p>'
      })

      // Save to LocalStorage whenever content changes
      useEffect(() => {
        localStorage.setItem(STORAGE_KEY, content)
      }, [content])

      return (
        <div className="app">
          <header className="app-header">
            <h1>Phish Monger</h1>
            <p>Phishing Email Annotation Tool</p>
          </header>
          <main className="app-main">
            <Editor
              content={content}
              onUpdate={setContent}
            />
            <div className="preview">
              <h2>HTML Preview</h2>
              <pre>{content}</pre>
            </div>
          </main>
        </div>
      )
    }

    export default App
    ```

    Then update src/index.css:

    ```css
    :root {
      font-family: Inter, system-ui, Avenir, Helvetica, Arial, sans-serif;
    }

    body {
      margin: 0;
      min-width: 320px;
      min-height: 100vh;
    }

    #root {
      max-width: 1280px;
      margin: 0 auto;
      padding: 2rem;
    }

    .app {
      width: 100%;
    }

    .app-header {
      margin-bottom: 2rem;
      border-bottom: 1px solid #ccc;
      padding-bottom: 1rem;
    }

    .app-header h1 {
      margin: 0;
      font-size: 2rem;
    }

    .app-header p {
      margin: 0.5rem 0 0 0;
      color: #666;
    }

    .app-main {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 2rem;
    }

    .editor-container {
      border: 1px solid #ccc;
      border-radius: 4px;
      background: white;
    }

    .editor-toolbar {
      display: flex;
      gap: 0.5rem;
      padding: 0.5rem;
      border-bottom: 1px solid #ccc;
      background: #f5f5f5;
    }

    .toolbar-btn {
      padding: 0.5rem 1rem;
      border: 1px solid #ccc;
      border-radius: 4px;
      background: white;
      cursor: pointer;
      font-size: 0.875rem;
    }

    .toolbar-btn:hover:not(:disabled) {
      background: #e5e5e5;
    }

    .toolbar-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .toolbar-btn.is-active {
      background: #007bff;
      color: white;
    }

    .toolbar-btn-lure {
      background: #fff3cd;
      font-weight: bold;
    }

    .toolbar-btn-lure:hover:not(:disabled) {
      background: #ffe69c;
    }

    .toolbar-divider {
      width: 1px;
      background: #ccc;
      margin: 0 0.5rem;
    }

    .editor-content {
      padding: 1rem;
      min-height: 400px;
    }

    /* Tiptap editor styles */
    .ProseMirror {
      outline: none;
    }

    .ProseMirror p {
      margin: 1em 0;
    }

    .ProseMirror h1, .ProseMirror h2, .ProseMirror h3 {
      margin: 1em 0 0.5em 0;
    }

    .ProseMirror a {
      color: #007bff;
      text-decoration: underline;
    }

    /* Lure Mark highlight styling */
    .lure-mark {
      background-color: #fff3cd;
      border-bottom: 2px solid #ffc107;
      padding: 2px 4px;
      border-radius: 2px;
    }

    /* Preview panel */
    .preview {
      border: 1px solid #ccc;
      border-radius: 4px;
      padding: 1rem;
      background: #f5f5f5;
      overflow: auto;
      max-height: 500px;
    }

    .preview h2 {
      margin-top: 0;
      font-size: 1.25rem;
    }

    .preview pre {
      background: white;
      padding: 1rem;
      border: 1px solid #ccc;
      border-radius: 4px;
      white-space: pre-wrap;
      word-wrap: break-word;
      font-size: 0.875rem;
    }

    @media (max-width: 768px) {
      .app-main {
        grid-template-columns: 1fr;
      }
    }
    ```

     This provides:
     - Main app with header and editor
     - Two-column layout (editor + preview)
     - Toolbar with visual feedback
     - Yellow highlight for Lure Marks (#fff3cd background, #ffc107 underline)
     - Responsive design
     - LocalStorage persistence: Content saves automatically on change
     - LocalStorage persistence: Content loads from LocalStorage on mount
     - Lure Marks with UUIDs persist across page reloads
  </action>
  <verify>
    Check that src/App.tsx imports Editor component and manages content state.
    Check that src/App.tsx has useEffect for localStorage.setItem on content changes.
    Check that src/App.tsx initializes content from localStorage.getItem on mount.
    Check that src/index.css has .lure-mark styling with yellow background and underline.
    Confirm toolbar buttons are styled with hover and active states.
  </verify>
  <done>
    Main App component with Editor and LocalStorage persistence is created with full styling including yellow Lure Mark highlights.
  </done>
</task>

</tasks>

<verification>
1. Check src/components/Editor.tsx - Has useEditor hook with LureMark extension
2. Check src/components/Editor.tsx - Has handlePaste that calls sanitizeHtml
3. Check src/App.tsx - Renders Editor component and manages content state
4. Check src/App.tsx - Has localStorage.getItem in useState initializer for loading content
5. Check src/App.tsx - Has useEffect with localStorage.setItem for saving content
6. Check src/index.css - Has .lure-mark styling with yellow background
7. Check src/index.css - Has toolbar button styles
</verification>

<success_criteria>
- Editor component integrates Tiptap with LureMark extension
- Editor sanitizes pasted HTML using sanitizeHtml
- Toolbar has Bold, Italic, Link, and Mark Lure buttons
- Mark Lure button wraps selected text in Lure Mark with UUID
- App renders Editor and manages content state
- Lure Marks display with yellow highlight styling
- Editor content saves to LocalStorage on every change
- Editor content loads from LocalStorage on mount
- Lure Marks with UUIDs persist across page reloads
</success_criteria>

<output>
After completion, create `.planning/phases/01-editor-foundation/01-03-SUMMARY.md`
</output>
