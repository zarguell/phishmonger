---
phase: 02-technique-annotations
plan: 02
type: execute
wave: 2
depends_on: [02-01]
files_modified: [src/App.tsx, src/components/AnnotationPanel.tsx]
autonomous: true
user_setup: []


must_haves:
  truths:
    - "App.tsx manages annotations state with Record<lureId, Annotation>"
    - "AnnotationPanel component renders forms for both Technique and Persuasion Principle"
    - "User can select Persuasion Principle from dropdown (optional)"
  artifacts:
    - path: "src/App.tsx"
      provides: "Annotation state management"
      contains: "useState<Record<string, Annotation>>"
    - path: "src/components/AnnotationPanel.tsx"
      provides: "Annotation form UI component"
      min_lines: 100
      exports: ["AnnotationPanel"]
  key_links:
    - from: "src/App.tsx"
      to: "src/types/annotations.ts"
      via: "Import Annotation type"
      pattern: "import.*Annotation.*from"
    - from: "src/components/AnnotationPanel.tsx"
      to: "src/data/persuasion.json"
      via: "Import persuasion library"
      pattern: "import.*persuasion.*from"
    - from: "src/components/AnnotationPanel.tsx"
      to: "src/types/annotations.ts"
      via: "Use Annotation and PersuasionPrinciple types"
      pattern: "interface AnnotationPanelProps"
---


<objective>
Create the UI and state management for technique annotations: add annotation state to App.tsx and build an AnnotationPanel component that supports both MITRE ATT&CK techniques and Cialdini Persuasion Principles.


Purpose: Enable users to select phishing techniques and psychological triggers from pre-loaded libraries and write custom explanations for each marked lure.
Output: Functional annotation state management and comprehensive form UI component.
</objective>


<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>


<context>
@.planning/STATE.md
@.planning/ROADMAP.md
@.planning/REQUIREMENTS.md
@.planning/phases/02-technique-annotations/02-RESEARCH.md
@.planning/phases/01-editor-foundation/01-07-SUMMARY.md
@.planning/phases/02-technique-annotations/02-01-SUMMARY.md
@src/types/annotations.ts
@src/data/techniques.json
@src/data/persuasion.json
</context>


<tasks>


<task type="auto">
  <name>Task 1: Add annotation state management to App.tsx</name>
  <files>src/App.tsx</files>
  <action>
    Extend App.tsx with annotation state management following the Record<lureId, Annotation> pattern.


    1. Import Annotation type from types/annotations.ts:
       ```typescript
       import type { Annotation } from './types/annotations'
       ```


    2. Add annotations state after htmlSource state:
       ```typescript
       const [annotations, setAnnotations] = useState<Record<string, Annotation>>(() => {
         const saved = localStorage.getItem('phishmonger-annotations')
         return saved ? JSON.parse(saved) : {}
       })
       ```


    3. Create updateAnnotation helper function:
       ```typescript
       const updateAnnotation = (lureId: string, updates: Partial<Annotation>) => {
         setAnnotations(prev => ({
           ...prev,
           [lureId]: {
             ...prev[lureId],
             ...updates,
             lureId,
             updatedAt: new Date().toISOString()
           }
         }))
       }
       ```


    IMPORTANT: Do NOT add LocalStorage persistence logic inside the setter yet (Task 3 in Plan 03 covers side effects).


    Also update handleRemoveLure to accept annotations parameter (for future use):
    ```typescript
    const handleRemoveLure = (lureId: string) => {
      // ...existing HTML removal logic...
      // Future: setAnnotations cleanup logic
    }
    ```
  </action>
  <verify>
    TypeScript compilation succeeds: `npx tsc --noEmit`. Check that Annotation type is imported and annotations state is defined.
  </verify>
  <done>
    App.tsx has annotation state management ready to be passed to child components.
  </done>
</task>


<task type="auto">
  <name>Task 2: Create AnnotationPanel component</name>
  <files>src/components/AnnotationPanel.tsx</files>
  <action>
    Create src/components/AnnotationPanel.tsx with form controls for technique selection, persuasion principles, and annotation editing.


    Import types and data:
    ```typescript
    import type { Annotation, Technique, PersuasionPrinciple } from '../types/annotations'
    import techniques from '../data/techniques.json'
    import persuasionPrinciples from '../data/persuasion.json'
    ```


    Define props interface:
    ```typescript
    interface AnnotationPanelProps {
      lureId: string
      lureText: string
      annotation?: Annotation
      onUpdate: (updates: Partial<Annotation>) => void
    }
    ```


    Implement the component with:
    1. Header: `Annotate: "{lureText}"`
    2. **Technique Section (MITRE):**
       - Label: "Technical Technique (What)"
       - Dropdown options from `techniques`
       - Default: "Select technique..."
       - Format: "{id}: {name}"
       - Binds to `annotation.techniqueId`
    3. **Persuasion Section (Psychology):**
       - Label: "Persuasion Principle (Why)"
       - Dropdown options from `persuasionPrinciples`
       - Default: "Select principle..."
       - Format: "{name}"
       - Binds to `annotation.persuasionPrincipleId`
    4. **Explanation Section:**
       - Label: "Analyst Notes"
       - Textarea (rows=4)
       - Binds to `annotation.explanation`


    All fields must use controlled components with value={annotation?.field || ''} and call onUpdate on change.


    Add basic CSS classes for styling:
    - annotation-panel (container)
    - annotation-section (grouping related fields)
    - annotation-label (labels)
    - annotation-select, annotation-textarea (inputs)
  </action>
  <verify>
    TypeScript compilation succeeds: `npx tsc --noEmit`. Component imports both JSON files and exports the interface correctly.
  </verify>
  <done>
    AnnotationPanel component renders technique dropdown, persuasion dropdown, and annotation form fields.
  </done>
</task>


</tasks>


<verification>
- App.tsx imports Annotation type and has annotations state
- AnnotationPanel imports both techniques.json and persuasion.json
- AnnotationPanel renders two distinct dropdowns (Technical vs. Psychological)
- TypeScript compilation passes
</verification>


<success_criteria>
Annotation state management exists in App.tsx and AnnotationPanel component supports both MITRE techniques and Cialdini principles.
</success_criteria>


<output>
After completion, create `.planning/phases/02-technique-annotations/02-02-SUMMARY.md`
</output>
