---
phase: 03-visualizer-export
plan: 08
type: execute
wave: 7
depends_on: [03-02, 03-03, 03-04, 03-05, 03-06, 03-07]
files_modified:
  - src/index.css
  - src/components/preview/AnnotationColumn.tsx
  - src/hooks/useCardLayout.ts
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Text and annotations are properly spaced with readable layout"
    - "Email content in left column, annotation cards in right column"
    - "No text overlapping or illegible content"
    - "Annotation cards visible within 640px column bounds"
    - "Arrows calculate to valid card coordinates"
    - "Cards render in vertical stack with 24px gap"
  artifacts:
    - path: src/index.css
      provides: "CSS with positioned context for annotation-column"
      contains: "position: relative"
    - path: src/components/preview/AnnotationColumn.tsx
      provides: "Cards rendered via flexbox, not absolute positioning"
      contains: "no position: absolute in style prop"
    - path: src/hooks/useCardLayout.ts
      provides: "Hook marked as deprecated or removed entirely"
      note: "May be deleted if absolute positioning fully removed"
  key_links:
    - from: "AnnotationColumn.tsx"
      to: ".annotation-column CSS"
      via: "className reference"
      pattern: "className=.annotation-column."
    - from: "ArrowOverlay getBoundingClientRect calls"
      to: "AnnotationCard elements"
      via: "DOM queries"
      pattern: "getBoundingClientRect.*annotation-card|card-.*-ref"
---

<objective>
Fix layout collapse in preview mode by replacing absolute positioning with flexbox layout for annotation cards.

Purpose: Root cause identified as .annotation-column lacking position: relative, causing parent collapse and coordinate system escape. Flexbox layout is simpler, more maintainable, and eliminates manual positioning logic.
Output: Cards render in visible column, arrows connect to valid coordinates, layout meets Phase 3 specifications.
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/debug/layout-collapse-root-cause.md
@.planning/phases/03-visualizer-export/03-visualizer-export-UAT.md
@.planning/phases/03-visualizer-export/03-03-SUMMARY.md

# Root Cause Summary
AnnotationColumn uses absolute positioning for cards without position: relative on parent. This causes:
- Parent collapses to height: 0
- Cards position relative to slide-wrapper or viewport (not the column)
- Cards render outside visible area â†’ arrows calculate to invalid coordinates

# Fix Strategy: Option B (Recommended)
Replace absolute positioning with flexbox layout:
1. Add position: relative to .annotation-column (safety measure)
2. Remove position: absolute from AnnotationCard style props
3. Remove useCardLayout hook (no longer needed)
4. Rely on flexbox gap: 24px for card spacing

Advantages:
- Simpler - no manual Y calculations
- Responsive - flexbox handles spacing
- Maintainable - no collision detection logic
- Robust - parent has natural height from content
</context>

<tasks>

<task type="auto">
  <name>Add positioned context to annotation-column CSS</name>
  <files>src/index.css</files>
  <action>
    Modify .annotation-column rule (lines 422-430):

    1. Add `position: relative;` after `box-sizing: border-box;`
       - This establishes positioning context as safety measure
       - Ensures any absolutely-positioned children reference this parent

    2. Keep existing flex properties (display: flex, flex-direction: column, gap: 24px)
       - Flexbox gap will handle card spacing naturally

    3. No min-height needed - parent height from flex content

    Reference: src/index.css lines 422-430
    Current CSS has correct flex structure, just missing position: relative
  </action>
  <verify>grep -A 8 "\.annotation-column" src/index.css shows "position: relative;"</verify>
  <done>.annotation-column has position: relative and flex properties for natural card layout</done>
</task>

<task type="auto">
  <name>Remove absolute positioning from AnnotationColumn component</name>
  <files>src/components/preview/AnnotationColumn.tsx</files>
  <action>
    Refactor AnnotationColumn to use flexbox layout instead of absolute positioning:

    1. Remove useCardLayout import (line 2)
    2. Remove cardPositions const (line 10)
    3. Update render logic (lines 25-41):
       - Remove cardPositions.map() iteration
       - Use Object.values(annotations).map() directly
       - Remove style prop with position: absolute, top, left, width
       - Let flexbox handle positioning

    Expected structure:
    ```tsx
    return (
      <div className="annotation-column">
        {Object.values(annotations).map((annotation) => (
          <AnnotationCard
            key={annotation.lureId}
            annotation={annotation}
            // No style prop - flexbox handles layout
          />
        ))}
      </div>
    )
    ```

    Reference: src/components/preview/AnnotationColumn.tsx lines 23-43
    Current implementation passes style prop with absolute positioning
  </action>
  <verify>grep -v "position.*absolute" src/components/preview/AnnotationColumn.tsx - no matches</verify>
  <done>AnnotationColumn renders cards via flexbox, no absolute positioning</done>
</task>

<task type="auto">
  <name>Delete deprecated useCardLayout hook</name>
  <files>src/hooks/useCardLayout.ts</files>
  <action>
    Delete src/hooks/useCardLayout.ts entirely.

    Rationale:
    - Hook calculates Y positions for absolute positioning
    - With flexbox layout, manual positioning unnecessary
    - Keeping dead code confuses future maintainers

    Alternative: If you prefer to keep as historical reference:
    1. Add DEPRECATED comment at top of file
    2. Add JSDoc warning: "@deprecated Use flexbox layout instead"
    3. But recommendation is DELETE to avoid accidental usage

    Reference: src/hooks/useCardLayout.ts
    File provides collision detection and Y position calculation
  </action>
  <verify>ls src/hooks/useCardLayout.ts returns "No such file or directory"</verify>
  <done>useCardLayout hook removed, no manual positioning logic</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Layout collapse fix - annotation cards now render via flexbox instead of absolute positioning</what-built>
  <how-to-verify>
    1. Start dev server: npm run dev
    2. Open application in browser
    3. Paste phishing email HTML (or use existing content)
    4. Mark at least 2-3 lures and add annotations
    5. Click "Preview Mode" button

    Expected results:
    - EmailColumn visible on left (960px width)
    - AnnotationColumn visible on right (640px width)
    - Cards stacked vertically with ~24px gap between them
    - No text overlap or elements outside column bounds
    - Cards appear inside visible column area (not "in the void")
    - Arrows connect from highlighted text to card centers
    - Export PNG retains proper layout

    If issue persists:
    - Check browser DevTools Elements panel
    - Verify .annotation-column has position: relative
    - Verify cards don't have position: absolute
    - Share screenshot or DevTools screenshot
  </how-to-verify>
  <resume-signal>Type "approved" if layout is correct, or describe what's still broken</resume-signal>
</task>

</tasks>

<verification>
After fix is applied and verified:

1. CSS verification:
   - .annotation-column has position: relative
   - .annotation-column has display: flex, flex-direction: column, gap: 24px
   - No min-height hardcoded (content defines height)

2. Component verification:
   - AnnotationColumn no longer uses useCardLayout hook
   - AnnotationColumn maps Object.values(annotations) directly
   - No style prop with position: absolute passed to AnnotationCard

3. Runtime verification:
   - Cards render in visible column area
   - Cards stack vertically with consistent gap
   - ArrowOverlay getBoundingClientRect returns valid coordinates
   - Arrows connect from lure text to card positions
   - Export PNG shows proper layout

4. Regression verification:
   - Ghost card still renders when no annotations
   - Preview mode toggle works
   - Export PNG button works
</verification>

<success_criteria>
Layout collapse issue resolved:
- Cards render in visible 640px annotation column
- No text overlap or elements outside bounds
- Arrows connect to valid card coordinates
- Export PNG retains proper layout
- useCardLayout hook removed (simplified codebase)
</success_criteria>

<output>
After completion, create `.planning/phases/03-visualizer-export/03-08-SUMMARY.md`
</output>
