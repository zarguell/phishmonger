---
phase: 09-campaign-data-model
plan: 02
type: execute
wave: 2
depends_on:
  - 09-01
files_modified:
  - src/utils/storage.ts
  - src/utils/schemaVersion.ts
autonomous: true

must_haves:
  truths:
    - "CAMPAIGNS_KEY constant defined for LocalStorage key"
    - "SCHEMA_VERSION_KEY constant defined for schema versioning"
    - "loadCampaigns() function reads from LocalStorage with error handling"
    - "saveCampaigns() function writes to LocalStorage with try-catch for QuotaExceededError"
    - "loadSchemaVersion() returns current schema version (default 1 for v1.1, set to 2 for v1.2)"
    - "saveSchemaVersion() writes schema version to LocalStorage"
    - "initializeSchema() sets schema version to 2 on first run"
  artifacts:
    - path: "src/utils/storage.ts"
      provides: "Campaign CRUD storage utilities"
      exports: ["CAMPAIGNS_KEY", "loadCampaigns", "saveCampaigns"]
      min_lines: 50
    - path: "src/utils/schemaVersion.ts"
      provides: "Schema version management for future migrations"
      exports: ["SCHEMA_VERSION_KEY", "CURRENT_SCHEMA_VERSION", "loadSchemaVersion", "saveSchemaVersion", "initializeSchema"]
      min_lines: 30
  key_links:
    - from: "src/utils/storage.ts"
      to: "src/types/campaign.ts"
      via: "import Campaign"
      pattern: "import.*Campaign.*from.*types"
    - from: "src/utils/schemaVersion.ts"
      to: "localStorage"
      via: "SCHEMA_VERSION_KEY"
      pattern: "localStorage.getItem.*phishmonger-schema-version"
---

<objective>
LocalStorage schema extension for campaign persistence with schema versioning foundation.

Purpose: Establish storage utilities for persisting campaign entities in LocalStorage, following the existing pattern used for annotations and metadata. Schema versioning enables future migrations while current v1.2 implementation starts fresh (no actual v1.1->v1.2 migration needed per CONTEXT.md).
Output: Campaign storage functions (loadCampaigns, saveCampaigns) and schema version management utilities.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/STATE.md
@.planning/ROADMAP.md
@.planning/phases/09-campaign-data-model/09-CONTEXT.md
@.planning/phases/09-campaign-data-model/09-RESEARCH.md
@.planning/phases/09-campaign-data-model/09-01-SUMMARY.md

@src/utils/storage.ts
@src/types/campaign.ts
@src/types/phish.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add campaign storage utilities to storage.ts</name>
  <files>src/utils/storage.ts</files>
  <action>
    Extend src/utils/storage.ts with campaign storage functions. Add to the end of the file:

    ```typescript
    import type { Campaign } from '../types/campaign';

    const CAMPAIGNS_KEY = 'phishmonger-campaigns';

    /**
     * Load campaigns from LocalStorage
     * Returns empty array if no saved data exists
     */
    export const loadCampaigns = (): Campaign[] => {
      try {
        const saved = localStorage.getItem(CAMPAIGNS_KEY);
        if (saved) {
          const parsed = JSON.parse(saved);
          // Validate that parsed data is an array
          if (Array.isArray(parsed)) {
            return parsed;
          }
          console.warn('Invalid campaigns data in LocalStorage, starting fresh');
          return [];
        }
      } catch (error) {
        console.error('Failed to load campaigns from LocalStorage:', error);
      }
      return [];
    };

    /**
     * Save campaigns to LocalStorage
     * Throws QuotaExceededError if storage is full
     */
    export const saveCampaigns = (campaigns: Campaign[]): void => {
      try {
        localStorage.setItem(CAMPAIGNS_KEY, JSON.stringify(campaigns));
      } catch (error) {
        if (error instanceof Error && error.name === 'QuotaExceededError') {
          throw error; // Re-throw for useCampaigns to handle
        }
        console.error('Failed to save campaigns to LocalStorage:', error);
        throw error;
      }
    };
    ```

    Follow the existing pattern in storage.ts:
    - Try-catch wrapper with console.error for logging
    - Return default empty array on error (defensive)
    - Use 'phishmonger-' prefix for key naming consistency
    - Validate parsed data structure (Array.isArray check)

    DO NOT add migration logic - CONTEXT.md states no v1.1->v1.2 migration needed (zero existing users).
  </action>
  <verify>grep -q "CAMPAIGNS_KEY" src/utils/storage.ts && grep -q "loadCampaigns" src/utils/storage.ts && grep -q "saveCampaigns" src/utils/storage.ts</verify>
  <done>loadCampaigns and saveCampaigns functions added to storage.ts following existing patterns</done>
</task>

<task type="auto">
  <name>Task 2: Create schema version management utilities</name>
  <files>src/utils/schemaVersion.ts</files>
  <action>
    Create src/utils/schemaVersion.ts for schema version management:

    ```typescript
    /**
     * Schema version management for Phish Monger
     *
     * Tracks the LocalStorage schema version to enable future migrations.
     * v1.2 uses schema version 2. Future versions can increment this and
     * run migration logic on app load when version mismatch is detected.
     *
     * No v1.1 -> v1.2 migration needed (zero existing users), but we establish
     * the schemaVersion field now for future migrations.
     */

    const SCHEMA_VERSION_KEY = 'phishmonger-schema-version';

    /**
     * Current schema version for this codebase
     * Increment this when LocalStorage structure changes in a way that
     * requires migration
     */
    export const CURRENT_SCHEMA_VERSION = 2;

    /**
     * Load schema version from LocalStorage
     * Returns 1 (v1.1) as default if not set (assumes pre-v1.2 install)
     */
    export function loadSchemaVersion(): number {
      try {
        const saved = localStorage.getItem(SCHEMA_VERSION_KEY);
        if (saved) {
          const parsed = parseInt(saved, 10);
          return isNaN(parsed) ? 1 : parsed;
        }
      } catch (error) {
        console.error('Failed to load schema version:', error);
      }
      return 1; // Default to v1.1 schema
    }

    /**
     * Save schema version to LocalStorage
     */
    export function saveSchemaVersion(version: number): void {
      try {
        localStorage.setItem(SCHEMA_VERSION_KEY, version.toString());
      } catch (error) {
        console.error('Failed to save schema version:', error);
      }
    }

    /**
     * Initialize schema version on first run or update
     * Sets the schema version to CURRENT_SCHEMA_VERSION
     *
     * Call this on app mount to ensure schema version is set.
     * Future migrations will check loadSchemaVersion() against
     * CURRENT_SCHEMA_VERSION and run migrations if mismatch.
     */
    export function initializeSchema(): void {
      const currentVersion = loadSchemaVersion();
      if (currentVersion !== CURRENT_SCHEMA_VERSION) {
        // Future: Run migration here based on currentVersion
        // For now, just set to current version
        saveSchemaVersion(CURRENT_SCHEMA_VERSION);
      }
    }
    ```

    Key decisions from CONTEXT.md:
    - CURRENT_SCHEMA_VERSION = 2 for v1.2
    - No actual migration logic needed now (zero existing users)
    - Establish pattern for future migrations

    DO NOT implement v1.1->v1.2 migration logic - CONTEXT.md explicitly states this is not needed.
  </action>
  <verify>test -f src/utils/schemaVersion.ts && grep -q "CURRENT_SCHEMA_VERSION = 2" src/utils/schemaVersion.ts && grep -q "initializeSchema" src/utils/schemaVersion.ts</verify>
  <done>Schema version utilities created with CURRENT_SCHEMA_VERSION = 2 and initializeSchema function</done>
</task>

</tasks>

<verification>
1. Check that loadCampaigns returns empty array when LocalStorage is empty
2. Check that saveCampaigns stores Campaign[] in LocalStorage with key 'phishmonger-campaigns'
3. Check that loadSchemaVersion returns 1 when not set (default v1.1)
4. Check that initializeSchema sets schema version to 2
5. Verify QuotaExceededError is re-thrown from saveCampaigns (not swallowed)
</verification>

<success_criteria>
- Campaigns can be loaded from and saved to LocalStorage
- Schema version tracking initialized with version 2
- Storage quota errors propagated for handling by useCampaigns hook
- Existing storage utilities (annotations, metadata, scoring) remain unaffected
</success_criteria>

<output>
After completion, create `.planning/phases/09-campaign-data-model/09-02-SUMMARY.md`
</output>
