---
phase: 05-data-persistence
plan: 02
type: execute
wave: 2
depends_on: [05-01]
files_modified:
  - src/App.tsx
  - src/utils/storage.ts
autonomous: false

must_haves:
  truths:
    - "ProjectSettings panel visible in edit mode header"
    - "User can input title and author in ProjectSettings"
    - "Metadata persists to LocalStorage on every change"
    - "Metadata loads automatically from LocalStorage on app load"
  artifacts:
    - path: "src/App.tsx"
      provides: "Project metadata state and persistence"
      exports: ["metadata state", "handleUpdateMetadata function"]
    - path: "src/utils/storage.ts"
      provides: "Export/import utilities for complete project"
      exports: ["exportProjectJSON", "importProjectJSON"]
  key_links:
    - from: "src/App.tsx"
      to: "localStorage"
      via: "useEffect with saveMetadata"
      pattern: "useEffect.*saveMetadata.*metadata"
    - from: "src/components/ProjectSettings.tsx"
      to: "src/App.tsx"
      via: "onUpdate prop callback"
      pattern: "onUpdate.*handleUpdateMetadata"
---

<objective>
Integrate ProjectSettings into App with persistence and add JSON export/import utilities

Purpose: Connect project metadata to main application state, ensure persistence, and enable full project export/import for backup and sharing
Output: ProjectSettings integrated in App, metadata persistence, JSON export/import functions
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/REQUIREMENTS.md

@.planning/phases/05-data-persistence/05-01-SUMMARY.md

@src/App.tsx
@src/utils/storage.ts
@src/types/project.ts
@src/components/ProjectSettings.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Integrate metadata state in App.tsx</name>
  <files>src/App.tsx</files>
  <action>
    Add to src/App.tsx:

    1. Import ProjectMetadata type and storage utilities:
    ```typescript
    import type { ProjectMetadata } from './types/project'
    import { loadMetadata, saveMetadata } from './utils/storage'
    ```

    2. Add metadata state (after existing states, before viewMode):
    ```typescript
    const [metadata, setMetadata] = useState<ProjectMetadata>(() => {
      return loadMetadata()
    })
    ```

    3. Add persistence useEffect (after scoring useEffect):
    ```typescript
    // Save metadata to LocalStorage
    useEffect(() => {
      saveMetadata(metadata)
    }, [metadata])
    ```

    4. Add handleUpdateMetadata function (after handleRemoveLure):
    ```typescript
    const handleUpdateMetadata = (updates: Partial<ProjectMetadata>) => {
      setMetadata(prev => ({
        ...prev,
        ...updates
      }))
    }
    ```

    Do NOT render ProjectSettings yet - that's in Task 2 checkpoint.
  </action>
  <verify>grep -q "useState<ProjectMetadata>" src/App.tsx && grep -q "loadMetadata()" src/App.tsx</verify>
  <done>Metadata state initialized from LocalStorage, persists on change</done>
</task>

<task type="auto">
  <name>Task 2: Create JSON export/import utilities</name>
  <files>src/utils/storage.ts</files>
  <action>
    Add to src/utils/storage.ts:

    ```typescript
    import type { ProjectMetadata } from '../types/project'

    export interface ProjectJSON {
      metadata: ProjectMetadata
      htmlSource: string
      annotations: Record<string, Annotation>
      scoring: ScoringData
      inputMode: InputMode
    }

    export const exportProjectJSON = (
      metadata: ProjectMetadata,
      htmlSource: string,
      annotations: Record<string, Annotation>,
      scoring: ScoringData,
      inputMode: InputMode
    ): string => {
      const project: ProjectJSON = {
        metadata,
        htmlSource,
        annotations,
        scoring,
        inputMode
      }
      return JSON.stringify(project, null, 2)
    }

    export const importProjectJSON = (jsonString: string): ProjectJSON => {
      try {
        const parsed = JSON.parse(jsonString)

        // Validate structure
        if (!parsed.metadata || !parsed.htmlSource || !parsed.annotations || !parsed.scoring) {
          throw new Error('Invalid project JSON: missing required fields')
        }

        // Validate metadata fields
        if (!parsed.metadata.title || typeof parsed.metadata.title !== 'string') {
          throw new Error('Invalid project JSON: metadata.title is required')
        }

        if (!parsed.metadata.createdAt || typeof parsed.metadata.createdAt !== 'string') {
          throw new Error('Invalid project JSON: metadata.createdAt is required')
        }

        return parsed
      } catch (error) {
        if (error instanceof SyntaxError) {
          throw new Error('Invalid JSON format')
        }
        throw error
      }
    }

    export const downloadProjectJSON = (jsonString: string, filename: string) => {
      const blob = new Blob([jsonString], { type: 'application/json' })
      const url = URL.createObjectURL(blob)
      const link = document.createElement('a')
      link.href = url
      link.download = `${filename}.json`
      document.body.appendChild(link)
      link.click()
      document.body.removeChild(link)
      URL.revokeObjectURL(url)
    }
    ```

    Add InputMode import: import type { InputMode } from '../components/ModeToggle'

    Validation ensures all required fields exist with correct types before applying to state.
  </action>
  <verify>grep -q "exportProjectJSON" src/utils/storage.ts && grep -q "importProjectJSON" src/utils/storage.ts && grep -q "downloadProjectJSON" src/utils/storage.ts</verify>
  <done>Export serializes all project data, import validates and returns ProjectJSON</done>
</task>

<task type="checkpoint:human-verify">
  <what-built>Metadata state integrated in App.tsx with LocalStorage persistence and JSON export/import utilities</what-built>
  <how-to-verify>
    1. Run app: npm run dev
    2. Open browser console and check for metadata in LocalStorage: localStorage.getItem('phishmonger-metadata')
    3. Verify metadata loads with createdAt timestamp (current ISO date)
    4. Test export function in console: exportProjectJSON(metadata, htmlSource, annotations, scoring, inputMode)
    5. Verify JSON string contains all fields: metadata, htmlSource, annotations, scoring, inputMode
    6. Test import validation with invalid JSON: importProjectJSON('{invalid}') - should throw error
    7. Test import with missing fields: importProjectJSON('{"metadata": {}}') - should throw error
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues</resume-signal>
</task>

</tasks>

<verification>
- Metadata state loads from LocalStorage on app initialization
- Metadata persists to LocalStorage on every change
- exportProjectJSON() returns valid JSON string with all project data
- importProjectJSON() validates structure and throws on invalid input
- downloadProjectJSON() triggers file download in browser
</verification>

<success_criteria>
1. Metadata state initialized with loadMetadata() on app load
2. Metadata persists to LocalStorage via useEffect
3. JSON export includes metadata, htmlSource, annotations, scoring, inputMode
4. JSON import validates all required fields before returning
5. Download utility creates blob and triggers file download
</success_criteria>

<output>
After completion, create `.planning/phases/05-data-persistence/05-02-SUMMARY.md`
</output>
