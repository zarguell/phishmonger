---
phase: 01-editor-foundation
plan: 06
type: execute
wave: 5
depends_on: ["01-05"]
files_modified: [src/components/Preview.tsx, src/components/LureList.tsx, src/App.tsx, src/index.css]
autonomous: true
user_setup: []

must_haves:
  truths:
    - "Preview pane renders HTML source as victim would see it"
    - "User can select text in Preview pane"
    - "Mark Lure button creates yellow highlight with unique UUID"
    - "Lure marks persist in HTML source as `<span data-lure-id>` tags"
    - "Multiple lures can be marked in same email"
    - "Preview updates in real-time when HTML source changes"
  artifacts:
    - path: "src/components/Preview.tsx"
      provides: "Live preview pane with HTML rendering and Lure marking"
      exports: ["Preview"]
      contains: "dangerouslySetInnerHTML", "useRef", "handleMarkLure"
    - path: "src/components/LureList.tsx"
      provides: "Sidebar listing all marked lures"
      exports: ["LureList"]
      contains: "lure list rendering", "scroll to lure"
    - path: "src/App.tsx"
      provides: "Main app with three-column layout (Input, Preview, Lure List)"
      contains: "HTMLInput", "Preview", "LureList", "handleMarkLure"
  key_links:
    - from: "src/components/Preview.tsx"
      to: "dompurify"
      via: "DOMPurify.sanitize"
      pattern: "DOMPurify\\.sanitize"
    - from: "src/components/Preview.tsx"
      to: "src/App.tsx"
      via: "onUpdate callback prop"
      pattern: "onUpdate\\?.\\(.*html"
    - from: "src/App.tsx"
      to: "src/components/Preview.tsx"
      via: "htmlSource prop"
      pattern: "htmlSource=\\{htmlSource\\}"
---

<objective>
Build a live Preview pane that renders HTML source as the victim would see the phishing email, with selection-based Lure marking workflow. Users select text in the Preview pane, click "Mark Lure" button, and the system injects `<span data-lure-id="UUID">` tags into the HTML source with yellow highlight styling.

Purpose: This is the core marking workflow from the new architecture. The Preview pane is where users see what the victim sees and mark deceptive techniques. It's the central component for phishing email annotation.

Output:
- Preview.tsx: Live preview pane with HTML rendering, DOM selection handling, and Lure marking
- LureList.tsx: Sidebar listing all marked lures with UUID and text preview
- App.tsx: Updated three-column layout (HTML Input, Preview, Lure List)
- index.css: Styling for preview pane and yellow Lure Mark highlights
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/STATE.md
@.planning/ROADMAP.md
@.planning/REQUIREMENTS.md
@.planning/phases/01-editor-foundation/01-04-ARCHITECTURAL-DECISION.md
@.planning/phases/01-editor-foundation/01-05-SUMMARY.md
@src/utils/sanitizeHtml.ts
</context>

<tasks>

<task type="auto">
  <name>Create Preview component with HTML rendering and selection handling</name>
  <files>src/components/Preview.tsx</files>
  <action>
    Create src/components/Preview.tsx:

    ```typescript
    import { useRef } from 'react'
    import DOMPurify from 'dompurify'
    import { sanitizeHtml } from '../utils/sanitizeHtml'

    interface PreviewProps {
      htmlSource: string
      onUpdate?: (newHtml: string) => void
    }

    export function Preview({ htmlSource, onUpdate }: PreviewProps) {
      const previewRef = useRef<HTMLDivElement>(null)

      const handleMarkLure = () => {
        const selection = window.getSelection()
        if (!selection || selection.rangeCount === 0) return

        const range = selection.getRangeAt(0)

        // Ensure selection is within preview pane
        if (!previewRef.current?.contains(range.commonAncestorContainer)) {
          alert('Please select text within the Preview pane')
          return
        }

        // Generate unique UUID for this lure
        const lureId = crypto.randomUUID()

        // Create span element with data-lure-id
        const span = document.createElement('span')
        span.setAttribute('data-lure-id', lureId)
        span.className = 'lure-mark'
        span.style.backgroundColor = '#fff3cd'
        span.style.borderBottom = '2px solid #ffc107'
        span.style.padding = '2px 4px'
        span.style.borderRadius = '2px'

        try {
          range.surroundContents(span)

          // Get updated HTML from preview pane
          const updatedHtml = previewRef.current?.innerHTML
          if (updatedHtml && onUpdate) {
            onUpdate(updatedHtml)
          }

          // Clear selection
          selection.removeAllRanges()
        } catch (error) {
          // Selection crosses element boundaries - can't use surroundContents
          alert('Please select text within a single element (not across multiple elements)')
        }
      }

      return (
        <div className="preview-container">
          <div className="preview-header">
            <h2>Preview (Victim View)</h2>
            <button
              onClick={handleMarkLure}
              className="mark-lure-btn"
              type="button"
            >
              Mark Lure
            </button>
          </div>
          <div
            ref={previewRef}
            className="preview-pane"
            dangerouslySetInnerHTML={{ __html: sanitizeHtml(htmlSource) }}
          />
        </div>
      )
    }
    ```

    Key features:
    - Renders HTML source using dangerouslySetInnerHTML with DOMPurify sanitization
    - useRef to access preview DOM for selection manipulation
    - "Mark Lure" button positioned in preview header (not in editor toolbar)
    - Selection validation: ensures selection is within preview pane
    - Unique UUID generation using crypto.randomUUID()
    - Wraps selected text in <span data-lure-id="UUID"> with inline styles
    - Calls onUpdate callback with updated HTML source
    - Error handling for selections crossing element boundaries
  </action>
  <verify>
    Check that src/components/Preview.tsx exists and exports Preview component.
    Verify imports: useRef from react, DOMPurify, sanitizeHtml from utils.
    Confirm handleMarkLure generates UUID and wraps selection in span element.
    Confirm "Mark Lure" button is in preview header, not editor toolbar.
    Verify selection validation checks previewRef.current.contains().
  </verify>
  <done>
    Preview component with HTML rendering, DOM selection handling, and Lure marking is created.
  </done>
</task>

<task type="auto">
  <name>Create LureList sidebar component</name>
  <files>src/components/LureList.tsx</files>
  <action>
    Create src/components/LureList.tsx:

    ```typescript
    import { useEffect, useState, useRef } from 'react'

    interface Lure {
      id: string
      text: string
    }

    interface LureListProps {
      htmlSource: string
    }

    export function LureList({ htmlSource }: LureListProps) {
      const [lures, setLures] = useState<Lure[]>([])

      useEffect(() => {
        // Parse HTML source to extract all data-lure-id attributes
        const parser = new DOMParser()
        const doc = parser.parseFromString(htmlSource, 'text/html')
        const lureElements = doc.querySelectorAll('[data-lure-id]')

        const extractedLures: Lure[] = []
        lureElements.forEach((el) => {
          const lureId = el.getAttribute('data-lure-id')
          const text = el.textContent?.slice(0, 50) || ''
          if (lureId) {
            extractedLures.push({ id: lureId, text })
          }
        })

        setLures(extractedLures)
      }, [htmlSource])

      const scrollToLure = (lureId: string) => {
        const lureElement = document.querySelector(`[data-lure-id="${lureId}"]`)
        if (lureElement) {
          lureElement.scrollIntoView({ behavior: 'smooth', block: 'center' })
          // Flash highlight
          lureElement.classList.add('lure-flash')
          setTimeout(() => {
            lureElement.classList.remove('lure-flash')
          }, 1000)
        }
      }

      return (
        <div className="lure-list">
          <h2>Lures ({lures.length})</h2>
          {lures.length === 0 ? (
            <p className="lure-list-empty">No lures marked yet. Select text in Preview and click "Mark Lure".</p>
          ) : (
            <ul className="lure-list-items">
              {lures.map((lure) => (
                <li key={lure.id} className="lure-list-item">
                  <button
                    onClick={() => scrollToLure(lure.id)}
                    className="lure-list-btn"
                    type="button"
                  >
                    <span className="lure-id">{lure.id.slice(0, 8)}</span>
                    <span className="lure-text">"{lure.text}"</span>
                  </button>
                </li>
              ))}
            </ul>
          )}
        </div>
      )
    }
    ```

    Key features:
    - Parses HTML source to extract all data-lure-id attributes
    - Displays list of lures with UUID (truncated to 8 chars) and text preview
    - Click lure to scroll to it in Preview pane (smooth scroll, center alignment)
    - Flash highlight animation when scrolling to lure
    - Empty state message when no lures marked
    - Updates list whenever htmlSource prop changes

    Add CSS for lure list (to index.css in next task):
    - .lure-list sidebar styling
    - .lure-list-items list styling
    - .lure-list-item button styling
    - .lure-flash animation
  </action>
  <verify>
    Check that src/components/LureList.tsx exists and exports LureList component.
    Verify useEffect parses htmlSource to extract data-lure-id attributes.
    Confirm scrollToLure uses querySelector and scrollIntoView.
    Confirm empty state message displays when lures array is empty.
  </verify>
  <done>
    LureList sidebar component with lure listing and scroll-to functionality is created.
  </done>
</task>

<task type="auto">
  <name>Update App.tsx with three-column layout and Lure marking state</name>
  <files>src/App.tsx</files>
  <action>
    Update src/App.tsx to integrate Preview and LureList components:

    ```typescript
    import { useState, useEffect } from 'react'
    import { HTMLInput } from './components/HTMLInput'
    import { Preview } from './components/Preview'
    import { LureList } from './components/LureList'
    import './index.css'

    const STORAGE_KEY = 'phishmonger-html-source'

    type InputMode = 'html' | 'richtext'

    function App() {
      const [inputMode, setInputMode] = useState<InputMode>('html')
      const [htmlSource, setHtmlSource] = useState(() => {
        const saved = localStorage.getItem(STORAGE_KEY)
        return saved || '<p>Start typing your phishing email here...</p>'
      })

      // Save to LocalStorage whenever htmlSource changes
      useEffect(() => {
        localStorage.setItem(STORAGE_KEY, htmlSource)
      }, [htmlSource])

      const handleMarkLure = (updatedHtml: string) => {
        setHtmlSource(updatedHtml)
      }

      return (
        <div className="app">
          <header className="app-header">
            <h1>Phish Monger</h1>
            <p>Phishing Email Annotation Tool</p>
          </header>
          <main className="app-main">
            <div className="input-column">
              <div className="mode-toggle">
                <button
                  onClick={() => setInputMode('html')}
                  className={`mode-btn ${inputMode === 'html' ? 'active' : ''}`}
                  type="button"
                >
                  HTML Input
                </button>
                <button
                  onClick={() => setInputMode('richtext')}
                  className={`mode-btn ${inputMode === 'richtext' ? 'active' : ''}`}
                  type="button"
                >
                  Rich Text
                </button>
              </div>
              {inputMode === 'html' ? (
                <HTMLInput
                  htmlSource={htmlSource}
                  onUpdate={setHtmlSource}
                />
              ) : (
                <div className="richtext-placeholder">
                  <p>Rich Text Editor (Phase 2)</p>
                </div>
              )}
            </div>
            <div className="preview-column">
              <Preview
                htmlSource={htmlSource}
                onUpdate={handleMarkLure}
              />
            </div>
            <div className="lure-list-column">
              <LureList htmlSource={htmlSource} />
            </div>
          </main>
        </div>
      )
    }

    export default App
    ```

    Key changes:
    - Three-column layout: Input (left), Preview (center), LureList (right)
    - Mode toggle: HTML Input â†” Rich Text (Rich Text placeholder for Phase 2)
    - HTMLInput component for raw HTML textarea mode
    - Preview component with onUpdate callback for Lure marking
    - LureList component shows all marked lures
    - handleMarkLure updates htmlSource state when lure is marked
    - LocalStorage persistence with updated key name

    Note: HTMLInput component should be from plan 01-05 (mode toggle and HTML input mode).
  </action>
  <verify>
    Check that src/App.tsx imports HTMLInput, Preview, LureList components.
    Verify three-column layout: input-column, preview-column, lure-list-column.
    Confirm mode toggle buttons switch between 'html' and 'richtext' modes.
    Confirm handleMarkLure function updates htmlSource state.
    Verify LocalStorage key is 'phishmonger-html-source'.
  </verify>
  <done>
    App.tsx updated with three-column layout, mode toggle, and Lure marking state management.
  </done>
</task>

<task type="auto">
  <name>Add CSS styling for Preview pane, LureList, and three-column layout</name>
  <files>src/index.css</files>
  <action>
    Update src/index.css with Preview pane and LureList styling:

    Add to existing CSS (or create new rules):

    ```css
    /* Three-column layout */
    .app-main {
      display: grid;
      grid-template-columns: 1fr 1fr 300px;
      gap: 1.5rem;
      align-items: start;
    }

    /* Input column */
    .input-column {
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }

    .mode-toggle {
      display: flex;
      gap: 0.5rem;
      padding: 0.5rem;
      background: #f5f5f5;
      border-radius: 4px;
    }

    .mode-btn {
      flex: 1;
      padding: 0.5rem 1rem;
      border: 1px solid #ccc;
      border-radius: 4px;
      background: white;
      cursor: pointer;
      font-size: 0.875rem;
    }

    .mode-btn:hover {
      background: #e5e5e5;
    }

    .mode-btn.active {
      background: #007bff;
      color: white;
      border-color: #007bff;
    }

    /* Preview column */
    .preview-column {
      border: 1px solid #ccc;
      border-radius: 4px;
      background: white;
      overflow: hidden;
    }

    .preview-container {
      height: 100%;
      display: flex;
      flex-direction: column;
    }

    .preview-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0.75rem 1rem;
      border-bottom: 1px solid #ccc;
      background: #f5f5f5;
    }

    .preview-header h2 {
      margin: 0;
      font-size: 1rem;
      font-weight: 600;
    }

    .mark-lure-btn {
      padding: 0.5rem 1rem;
      border: 1px solid #ffc107;
      border-radius: 4px;
      background: #fff3cd;
      color: #856404;
      cursor: pointer;
      font-size: 0.875rem;
      font-weight: 600;
    }

    .mark-lure-btn:hover {
      background: #ffe69c;
    }

    .preview-pane {
      flex: 1;
      padding: 2rem;
      overflow: auto;
      min-height: 500px;
    }

    /* Lure mark styling in preview */
    .preview-pane .lure-mark {
      background-color: #fff3cd;
      border-bottom: 2px solid #ffc107;
      padding: 2px 4px;
      border-radius: 2px;
    }

    .preview-pane .lure-flash {
      animation: flash 1s ease-in-out;
    }

    @keyframes flash {
      0%, 100% { background-color: #fff3cd; }
      50% { background-color: #ffe69c; }
    }

    /* Lure list column */
    .lure-list-column {
      border: 1px solid #ccc;
      border-radius: 4px;
      background: white;
      padding: 1rem;
      height: fit-content;
      max-height: 600px;
      overflow: auto;
    }

    .lure-list h2 {
      margin: 0 0 1rem 0;
      font-size: 1rem;
      font-weight: 600;
    }

    .lure-list-empty {
      color: #666;
      font-size: 0.875rem;
      font-style: italic;
    }

    .lure-list-items {
      list-style: none;
      padding: 0;
      margin: 0;
    }

    .lure-list-item {
      margin-bottom: 0.5rem;
    }

    .lure-list-btn {
      width: 100%;
      text-align: left;
      padding: 0.5rem;
      border: 1px solid #e0e0e0;
      border-radius: 4px;
      background: #fafafa;
      cursor: pointer;
      display: flex;
      flex-direction: column;
      gap: 0.25rem;
    }

    .lure-list-btn:hover {
      background: #f0f0f0;
      border-color: #ccc;
    }

    .lure-id {
      font-size: 0.75rem;
      color: #666;
      font-family: monospace;
    }

    .lure-text {
      font-size: 0.875rem;
      color: #333;
    }

    /* Responsive design */
    @media (max-width: 1024px) {
      .app-main {
        grid-template-columns: 1fr;
      }

      .preview-column {
        order: 1;
      }

      .input-column {
        order: 2;
      }

      .lure-list-column {
        order: 3;
      }
    }
    ```

    Key additions:
    - Three-column grid layout (1fr 1fr 300px)
    - Mode toggle button styling with active state
    - Preview container with header and pane sections
    - Mark Lure button with yellow theme
    - Lure mark styling in preview pane (yellow highlight)
    - Lure flash animation for scroll-to highlighting
    - Lure list sidebar with item buttons
    - Responsive design: stacks columns on mobile (Preview first)
  </action>
  <verify>
    Check that src/index.css has .app-main grid with three columns.
    Verify .preview-container styling with header and pane sections.
    Confirm .mark-lure-btn has yellow theme (#fff3cd background, #ffc107 border).
    Verify .lure-mark styling has yellow background and underline.
    Confirm .lure-list-column has fixed width 300px and max-height for scrolling.
    Verify responsive media query stacks columns on mobile.
  </verify>
  <done>
    CSS styling for Preview pane, LureList, and three-column layout is complete.
  </done>
</task>

</tasks>

<verification>
1. Check src/components/Preview.tsx - Renders HTML with dangerouslySetInnerHTML
2. Check src/components/Preview.tsx - Sanitizes HTML using DOMPurify via sanitizeHtml
3. Check src/components/Preview.tsx - Has "Mark Lure" button in preview header
4. Check src/components/Preview.tsx - handleMarkLure generates UUID and wraps selection in span
5. Check src/components/LureList.tsx - Parses htmlSource to extract data-lure-id attributes
6. Check src/components/LureList.tsx - scrollToLure uses querySelector and scrollIntoView
7. Check src/App.tsx - Three-column layout with HTMLInput, Preview, LureList
8. Check src/App.tsx - handleMarkLure updates htmlSource state
9. Check src/index.css - .lure-mark has yellow background (#fff3cd) and underline (#ffc107)
10. Check src/index.css - Three-column grid layout is responsive
</verification>

<success_criteria>
- Preview pane renders HTML content correctly using dangerouslySetInnerHTML
- Preview pane sanitizes HTML using DOMPurify (strips scripts and events)
- User can select text in Preview pane
- Mark Lure button creates yellow highlight with unique UUID
- Lure marks appear in HTML source as `<span data-lure-id="UUID">`
- Multiple lures can be marked in same email
- Lure list sidebar shows all marked lures with UUID and text preview
- Click lure in list scrolls to highlight in Preview pane
- Preview updates in real-time when HTML source changes
- Lure marks persist across page reloads (LocalStorage)
- Three-column layout is responsive on mobile
</success_criteria>

<output>
After completion, create `.planning/phases/01-editor-foundation/01-06-SUMMARY.md`
</output>
